<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debt Empire — Step 5: Comprehensive Evidence Package</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; color: #333; line-height: 1.5; }
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 { font-size: 22px; margin-bottom: 6px; }
        .header .subtitle { font-size: 13px; opacity: 0.9; }
        .layout {
            display: flex;
            min-height: calc(100vh - 120px);
            gap: 0;
        }
        .left-panel {
            width: 50%;
            background: white;
            border-right: 2px solid #e0e0e0;
            padding: 16px;
            overflow-y: auto;
        }
        .right-panel {
            width: 50%;
            background: #fafafa;
            padding: 16px;
            overflow-y: auto;
        }
        .section-title {
            font-size: 14px;
            font-weight: 700;
            margin: 16px 0 8px 0;
            color: #1a237e;
            border-bottom: 2px solid #3949ab;
            padding-bottom: 4px;
        }
        .section-title.money::before { content: "Rs "; }
        .input-row { margin: 6px 0; }
        .input-row label { display: block; font-size: 12px; font-weight: 500; margin-bottom: 2px; }
        .input-row input, .input-row select, .input-row textarea { width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
        .input-row textarea { min-height: 50px; resize: vertical; }
        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: #3949ab;
            color: white;
        }
        .btn:hover { opacity: 0.9; }
        .btn-success { background: #2e7d32; }
        .btn-primary { background: #1565c0; padding: 10px 18px; font-size: 14px; }
        .ev-item { margin: 8px 0; padding: 8px; background: white; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 12px; }
        .ev-item .cb-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .ev-item .cb-row input[type="checkbox"] { width: auto; }
        .ev-item .file-row { margin-top: 4px; font-size: 11px; color: #666; }
        .month-table { width: 100%; font-size: 11px; border-collapse: collapse; }
        .month-table th, .month-table td { padding: 4px 6px; border: 1px solid #e0e0e0; }
        .month-table th { background: #e8eaf6; }
        .action-bar { margin: 20px 0; padding: 16px; background: #e3f2fd; border-radius: 6px; text-align: center; }
        .action-bar .btn { margin: 0 6px; }
        .note-small { font-size: 11px; color: #666; margin-top: 6px; font-style: italic; }
        .hardship-suggested-box { margin-top: 12px; padding: 12px; background: #e3f2fd; border-radius: 6px; border: 1px solid #bbdefb; }
        .hardship-template-label { display: block; margin: 4px 0; padding: 4px 8px; font-size: 11px; color: #1565c0; cursor: pointer; border-radius: 4px; }
        .hardship-template-label:hover { background: #bbdefb; }
        @media (max-width: 900px) { .layout { flex-direction: column; } .left-panel, .right-panel { width: 100%; } }
        .internal-helper { font-size: 11px; color: #666; margin-top: 4px; font-style: italic; }
        @media print {
            .internal-helper { display: none !important; }
            .ev-item[data-ac-units-empty="true"] { display: none !important; }
            .ev-item[data-awareness-meetings-empty="true"] { display: none !important; }
            #certificate-generator, #certificate-preview-container { display: none !important; }
            .certificate-form { display: none !important; }
        }
        .certificate-form { margin: 12px 0; padding: 12px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; }
        .certificate-form h4 { margin-bottom: 10px; color: #1a237e; }
        .certificate { font-family: 'Times New Roman', serif; max-width: 800px; margin: 0 auto; padding: 40px; border: 2px solid #000; background: white; }
        .certificate h1 { font-size: 24pt; font-weight: bold; color: #1a3c5e; margin: 0; text-align: center; }
        .certificate-preview { margin: 20px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Debt Empire — Step 5: Comprehensive Evidence Package</h1>
        <div class="subtitle">Final OTS Submission Builder — Financial journey, loss summary, and evidence checklist per lender</div>
    </div>

    <div class="action-bar">
        <button type="button" class="btn" id="btnImportStep4">Import Hardship Data from Step 4</button>
        <input type="file" id="loadStep4File" accept=".json" style="display:none">
        <button type="button" class="btn" id="btnLoadStep4Json">Load Step 4 JSON File</button>
        <button type="button" class="btn btn-success" id="btnSaveTemplate">Save as Template</button>
        <button type="button" class="btn" id="btnLoadTemplate">Load Template</button>
        <input type="file" id="loadTemplateFile" accept=".json" style="display:none">
        <span id="importStatus" style="margin-left:10px;font-size:12px;"></span>
    </div>

    <div class="layout">
        <div class="left-panel">
            <div class="section-title">1. Rs Investment & Setup (One-time costs)</div>
            <div class="input-row"><label>Clinic registration & licences (Rs):</label><input type="number" id="inv_registration" min="0" placeholder="0"></div>
            <div class="input-row"><label>Rent deposit & advance (Rs):</label><input type="number" id="inv_rent" min="0" placeholder="0"></div>
            <div class="input-row"><label>Equipment & furniture (Rs):</label><input type="number" id="inv_equipment" min="0" placeholder="0"></div>
            <div class="input-row"><label>Interior & boards/signage (Rs):</label><input type="number" id="inv_signage" min="0" placeholder="0"></div>
            <div class="input-row"><label>Short note on interior work (HOMA Clinic):</label><textarea id="inv_interiorNote" rows="2" placeholder="Complete turnkey interior for HOMA Clinic (ceilings, partitions, pharmacy and lab furniture, reception, electrical and painting) as per attached quotation (approx. Rs. 17.2 lakh)."></textarea></div>
            <div class="input-row"><label>Real clinic photos note (optional):</label><textarea id="clinicPhotosNote" rows="2" placeholder="HOMA Clinic photos (exterior board, interior) showing professional setup before closure. Physical prints in court file if needed."></textarea></div>
            <div class="input-row"><label>Hospital software & IT (Rs):</label><input type="number" id="inv_software" min="0" placeholder="0"></div>
            <div class="input-row"><label>Initial medicine stock (Rs):</label><input type="number" id="inv_medicine" min="0" placeholder="0"></div>
            <div class="input-row"><label><strong>Total Investment (Rs):</strong></label><input type="number" id="inv_total" readonly placeholder="Auto-calculated"></div>
            <div class="input-row"><label>Govt Fees &amp; Compliance (Rs):</label><input type="number" id="govtFeesTotal" min="0" placeholder="0"></div>

            <div class="section-title">Running Expenses (Rs totals)</div>
            <div class="input-row"><label>Electricity/Phone/Internet:</label><input type="number" id="running_electricity" min="0" placeholder="0"></div>
            <div class="input-row"><label>Advances (equipment/pharma/marketing):</label><input type="number" id="running_advances" min="0" placeholder="0"></div>
            <div class="input-row"><label>Furniture/Equipment (fans, AC, chairs, stools):</label><input type="number" id="running_equipment" min="0" placeholder="0"></div>
            <div class="input-row"><label>Note on expenses (receipts attached):</label><textarea id="expensesNote" rows="2" placeholder="Online receipts, cash bills, pharma dues, equipment advances, etc."></textarea></div>

            <div class="section-title" style="margin-top:12px;">Online infra &amp; hosting (optional)</div>
            <div class="input-row"><label>Online infra &amp; hosting (Vercel / Supabase / Railway etc.) (Rs, approx total):</label><input type="number" id="onlineInfraTotal" min="0" placeholder="e.g. 5,000"></div>
            <div class="input-row"><label>Short note on online infra bills (optional):</label><textarea id="onlineInfraNote" rows="2" placeholder="Example: After closing HOMA Clinic in Oct 2024, I still paid Vercel, Supabase and Railway hosting bills to keep medical tools and records online. These are genuine business/OTS expenses, not personal luxury."></textarea></div>

            <div class="section-title" style="margin-top:20px;">Monthly Clinic Loss Calculator (Rent Excluded)</div>
            <div style="padding:12px;background:#f9f9f9;border:1px solid #ddd;border-radius:4px;margin-bottom:12px;">
                <p style="font-size:12px;margin:0 0 8px 0;color:#666;">Track Feb 2024-Oct 2024 (running losses) + Nov 2024-Feb 2026 (closure losses). EXCLUDE RENT. Shows ₹ outflow from Dr. Nehru's pocket monthly.</p>
                <div class="input-row" style="margin-bottom:8px;">
                    <label style="width:150px;">Select Month:</label>
                    <select id="monthlyLoss_month" style="width:200px;padding:4px;">
                        <option value="">-- Select Month --</option>
                        <option value="Feb24">Feb 2024</option>
                        <option value="Mar24">Mar 2024</option>
                        <option value="Apr24">Apr 2024</option>
                        <option value="May24">May 2024</option>
                        <option value="Jun24">Jun 2024</option>
                        <option value="Jul24">Jul 2024</option>
                        <option value="Aug24">Aug 2024</option>
                        <option value="Sep24">Sep 2024</option>
                        <option value="Oct24">Oct 2024</option>
                        <option value="Nov24">Nov 2024 (Closure Phase)</option>
                        <option value="Dec24">Dec 2024 (Closure Phase)</option>
                        <option value="Jan25">Jan 2025 (Closure Phase)</option>
                        <option value="Feb25">Feb 2025 (Closure Phase)</option>
                        <option value="Mar25">Mar 2025 (Closure Phase)</option>
                        <option value="Apr25">Apr 2025 (Closure Phase)</option>
                        <option value="May25">May 2025 (Closure Phase)</option>
                        <option value="Jun25">Jun 2025 (Closure Phase)</option>
                        <option value="Jul25">Jul 2025 (Closure Phase)</option>
                        <option value="Aug25">Aug 2025 (Closure Phase)</option>
                        <option value="Sep25">Sep 2025 (Closure Phase)</option>
                        <option value="Oct25">Oct 2025 (Closure Phase)</option>
                        <option value="Nov25">Nov 2025 (Closure Phase)</option>
                        <option value="Dec25">Dec 2025 (Closure Phase)</option>
                        <option value="Jan26">Jan 2026 (Closure Phase)</option>
                        <option value="Feb26">Feb 2026 (Closure Phase)</option>
                    </select>
                    <button type="button" class="btn" id="btnAddMonthlyLossRow" style="margin-left:10px;padding:4px 12px;">Add Row</button>
                    <button type="button" class="btn" id="btnCalculateMonthlyLoss" style="margin-left:10px;padding:4px 12px;">Calculate Monthly Loss</button>
                </div>
                <div id="monthlyLossTableContainer" style="margin-top:12px;">
                    <table class="month-table" id="monthlyLossTable" style="display:none;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Income ₹</th>
                                <th>Expense ₹</th>
                                <th>Running Balance</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="monthlyLossTableBody"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"><strong>Monthly Totals</strong></td>
                                <td id="monthlyLoss_totalIncome">0</td>
                                <td id="monthlyLoss_totalExpense">0</td>
                                <td id="monthlyLoss_netLoss">0</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div id="monthlyLossSummaryContainer" style="margin-top:16px;display:none;">
                    <div class="section-title" style="font-size:13px;margin-bottom:8px;">Monthly Loss Summary</div>
                    <table class="month-table" id="monthlyLossSummaryTable">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Total Expense</th>
                                <th>Income</th>
                                <th>Net Loss</th>
                                <th>Cumulative Loss</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyLossSummaryBody"></tbody>
                    </table>
                </div>
                <div style="margin-top:12px;">
                    <button type="button" class="btn btn-success" id="btnExportMonthlyLosses" style="padding:6px 16px;">Export Monthly Losses (CSV + PDF)</button>
                </div>
            </div>

            <div class="section-title" style="margin-top:20px;">Monthly Expense Tracker (Blank Template)</div>
            <div style="padding:12px;background:#f9f9f9;border:1px solid #ddd;border-radius:4px;margin-bottom:12px;">
                <p style="font-size:12px;margin:0 0 8px 0;color:#666;">Fixed 12-row template. Enter dates/expenses → auto-sum Monthly Loss + Cumulative. Income always zero.</p>
                <div class="input-row" style="margin-bottom:8px;">
                    <label style="width:150px;">Select Month:</label>
                    <select id="expenseTracker_month" style="width:200px;padding:4px;">
                        <option value="">-- Select Month --</option>
                        <option value="Feb24">Feb 2024</option>
                        <option value="Mar24">Mar 2024</option>
                        <option value="Apr24">Apr 2024</option>
                        <option value="May24">May 2024</option>
                        <option value="Jun24">Jun 2024</option>
                        <option value="Jul24">Jul 2024</option>
                        <option value="Aug24">Aug 2024</option>
                        <option value="Sep24">Sep 2024</option>
                        <option value="Oct24">Oct 2024</option>
                        <option value="Nov24">Nov 2024</option>
                        <option value="Dec24">Dec 2024</option>
                        <option value="Jan25">Jan 2025</option>
                        <option value="Feb25">Feb 2025</option>
                        <option value="Mar25">Mar 2025</option>
                        <option value="Apr25">Apr 2025</option>
                        <option value="May25">May 2025</option>
                        <option value="Jun25">Jun 2025</option>
                        <option value="Jul25">Jul 2025</option>
                        <option value="Aug25">Aug 2025</option>
                        <option value="Sep25">Sep 2025</option>
                        <option value="Oct25">Oct 2025</option>
                        <option value="Nov25">Nov 2025</option>
                        <option value="Dec25">Dec 2025</option>
                        <option value="Jan26">Jan 2026</option>
                        <option value="Feb26">Feb 2026</option>
                    </select>
                    <button type="button" class="btn" id="btnCalculateExpenseTracker" style="margin-left:10px;padding:4px 12px;">Calculate</button>
                    <button type="button" class="btn btn-success" id="btnExportExpenseTracker" style="margin-left:10px;padding:4px 12px;">Export (CSV + PDF)</button>
                </div>
                <div id="expenseTrackerTableContainer" style="margin-top:12px;">
                    <table class="month-table" id="expenseTrackerTable" style="display:none;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Expense ₹</th>
                            </tr>
                        </thead>
                        <tbody id="expenseTrackerTableBody"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="2"><strong>Monthly Total Expense</strong></td>
                                <td id="expenseTracker_totalExpense" style="font-weight:bold;color:#d32f2f;">0</td>
                            </tr>
                            <tr>
                                <td colspan="2"><strong>Monthly Net Loss</strong></td>
                                <td id="expenseTracker_netLoss" style="font-weight:bold;color:#d32f2f;">0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div id="expenseTrackerSummaryContainer" style="margin-top:16px;display:none;">
                    <div class="section-title" style="font-size:13px;margin-bottom:8px;">Cumulative Loss Summary</div>
                    <table class="month-table" id="expenseTrackerSummaryTable">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Total Expense</th>
                                <th>Net Loss</th>
                                <th>Cumulative Loss</th>
                            </tr>
                        </thead>
                        <tbody id="expenseTrackerSummaryBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="section-title">2. Monthly Revenue & Losses</div>
            <div class="input-row"><button type="button" class="btn" id="btnAddMonth">Add Month</button></div>
            <table class="month-table" id="monthTable">
                <thead><tr><th>Month/Year</th><th>Revenue (Rs)</th><th>Expenses (Rs)</th><th>Net P/L</th><th></th></tr></thead>
                <tbody id="monthTableBody"></tbody>
                <tfoot><tr><td><strong>Total</strong></td><td id="totRevenue">0</td><td id="totExpenses">0</td><td id="totNet">0</td><td></td></tr></tfoot>
            </table>

            <div class="section-title" style="margin-top:16px;">LoanLens 12‑Month Cashflow Summary (optional)</div>
            <p class="note-small">Narrative/evidence only. Not fed into Grand Total Losses or other calculators.</p>
            <table class="month-table" id="monthlyLensTable">
                <thead>
                    <tr>
                        <th>Month/Year</th>
                        <th>Real Income / Net Cashflow (Rs)</th>
                        <th>EMI &amp; Loans (Rs)</th>
                        <th>Rent (Rs)</th>
                        <th>Other Expenses (Rs)</th>
                        <th>Net Result (Rs)</th>
                    </tr>
                </thead>
                <tbody id="monthlyLensTableBody"></tbody>
            </table>
            <div class="input-row" style="margin-top:10px;">
                <label>12‑month hardship note (optional):</label>
                <textarea id="monthlyLensNote" rows="3" placeholder="Example: Across 12 months, EMIs and expenses were consistently higher than real income; some months required new borrowing just to pay EMIs."></textarea>
            </div>

            <div class="section-title">3. Loan Payment History (Current Lender)</div>
            <div class="input-row"><label>Lender Name:</label><input type="text" id="loan_lender" placeholder="e.g. HDFC, Bajaj Finance"></div>
            <div class="input-row"><label>Account Number:</label><input type="text" id="loan_account" placeholder="Account ref"></div>
            <div class="input-row"><label>Loan Amount Original (Rs):</label><input type="number" id="loan_original" min="0" placeholder="0"></div>
            <div class="input-row"><label>Processing Fees Paid (Rs):</label><input type="number" id="loan_processing" min="0" placeholder="0"></div>
            <div class="input-row"><label>First EMI Date:</label><input type="text" id="loan_firstEmi" placeholder="e.g. 2020-04"></div>
            <div class="input-row"><label>EMI Amount (Rs):</label><input type="number" id="loan_emi" min="0" placeholder="0"></div>
            <div class="input-row"><label>Months Paid:</label><input type="number" id="loan_monthsPaid" min="0" placeholder="0"></div>
            <div class="input-row"><label>Total Amount Paid (Rs):</label><input type="number" id="loan_totalPaid" readonly placeholder="Auto"></div>
            <div class="input-row"><label>Outstanding Balance (Rs):</label><input type="number" id="loan_outstanding" min="0" placeholder="0"></div>
            <div class="input-row"><label>Proposed OTS %:</label><input type="number" id="loan_otsPct" min="1" max="100" placeholder="70"></div>
            <div class="input-row"><label>OTS Amount (Rs):</label><input type="number" id="loan_otsAmt" readonly placeholder="Auto"></div>
            <div class="input-row"><label>Savings (Rs):</label><input type="number" id="loan_savings" readonly placeholder="Auto"></div>

            <div class="section-title">3B. EMI Payment Tracker (Post-Closure Interest = Loss Evidence)</div>
            <p class="note-small">Track monthly EMI payments showing Principal + Interest breakdown. <strong>Post-closure interest payments prove financial burden and good faith for OTS.</strong></p>
            <div class="input-row"><button type="button" class="btn" id="btnAddEmiRow">Add EMI Payment Row</button></div>
            <table class="month-table" id="emiTrackerTable">
                <thead><tr><th>Month/Year</th><th>Principal (Rs)</th><th>Interest (Rs)</th><th>Total EMI (Rs)</th><th>Status</th><th></th></tr></thead>
                <tbody id="emiTrackerTableBody"></tbody>
                <tfoot>
                    <tr>
                        <td><strong>Total</strong></td>
                        <td id="totEmiPrincipal">0</td>
                        <td id="totEmiInterest" style="color:#d32f2f;font-weight:bold;">0</td>
                        <td id="totEmi">0</td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="background:#fff3e0;">
                        <td colspan="2"><strong>Post-Closure Interest Paid (Loss)</strong></td>
                        <td colspan="4" id="postClosureInterest" style="color:#d32f2f;font-weight:bold;font-size:14px;">Rs 0</td>
                    </tr>
                </tfoot>
            </table>

            <div class="section-title">4. Tax & Compliance Costs</div>
            <div class="input-row"><label>IT Returns (FY22-23):</label><input type="checkbox" id="tax_fy22"> Filed <input type="file" id="tax_file22" accept=".pdf,.jpg,.png" style="font-size:11px"></div>
            <div class="input-row"><label>IT Returns (FY23-24):</label><input type="checkbox" id="tax_fy23"> Filed <input type="file" id="tax_file23" accept=".pdf,.jpg,.png" style="font-size:11px"></div>
            <div class="input-row"><label>IT Returns (FY24-25):</label><input type="checkbox" id="tax_fy24"> Filed <input type="file" id="tax_file24" accept=".pdf,.jpg,.png" style="font-size:11px"></div>
            <div class="input-row"><label>GST paid despite zero revenue (Rs):</label><input type="number" id="tax_gst" min="0" placeholder="0"></div>
            <div class="input-row"><label>Professional tax (Rs):</label><input type="number" id="tax_prof" min="0" placeholder="0"></div>
            <div class="input-row"><label>Other govt fees (Rs):</label><input type="number" id="tax_other" min="0" placeholder="0"></div>

            <div class="section-title">5. Legal & Court Costs</div>
            <div class="input-row"><label>Court notice fees (Rs):</label><input type="number" id="legal_notice" min="0" placeholder="0"></div>
            <div class="input-row"><label>Lawyer consultation fees (Rs):</label><input type="number" id="legal_lawyer" min="0" placeholder="0"></div>
            <div class="input-row"><label>Court notices/summons:</label><input type="file" id="legal_files" multiple accept=".pdf,.jpg,.png" style="font-size:11px"></div>

            <div class="section-title">6. Family Health Expenses</div>
            <div class="input-row"><label>Borrower medical costs (Rs):</label><input type="number" id="health_borrower" min="0" placeholder="0"></div>
            <div class="input-row"><label>Spouse medical costs (Rs):</label><input type="number" id="health_spouse" min="0" placeholder="0"></div>
            <div class="input-row"><label>Health certificates/bills:</label><input type="file" id="health_files" multiple accept=".pdf,.jpg,.png" style="font-size:11px"></div>

            <!-- Section 7: Major Asset Sale - Add new sections by inserting before this block with same .section-title + .input-row pattern -->
            <div class="section-title">7. Major Asset Sold to Repay Debts (Optional)</div>
            <p class="note-small">Use this section when you have sold a house, land, or other big asset and used the money mainly to repay loans related to the clinic.</p>
            <div class="input-row"><label>Property description:</label><input type="text" id="asset_propertyDesc" placeholder="House No. 2/8, Bahar-B, Sahara States, Mansoorabad"></div>
            <div class="input-row"><label>Location / address:</label><input type="text" id="asset_address" placeholder="Mansoorabad, Saroornagar, Ranga Reddy, Telangana"></div>
            <div class="input-row"><label>Document / registration details:</label><input type="text" id="asset_registrationDetails" placeholder="Sale Deed Doc No. 4654/2025, SRO Saroornagar, dated 16-07-2025"></div>
            <div class="input-row"><label>Sale value (Rs):</label><input type="number" id="asset_saleValue" min="0" placeholder="4980000"></div>
            <div class="input-row"><label>Date of sale / registration:</label><input type="date" id="asset_saleDate"></div>
            <div class="input-row"><label>Net amount actually received (Rs, after deductions):</label><input type="number" id="asset_netReceived" min="0" placeholder="Optional"></div>
            <div class="input-row"><label>Main reason for sale:</label><textarea id="asset_reasonForSale" rows="3" placeholder="Forced sale due to continuous clinic losses and inability to pay EMIs."></textarea></div>
            <div class="input-row"><label>Short note on how sale proceeds were used:</label><textarea id="asset_usageNote" rows="4" placeholder="Proceeds used mainly to close one Bajaj loan and part-pay another clinic loan; not used for lifestyle."></textarea></div>
            <div class="input-row"><button type="button" class="btn" id="btnAddAssetDebt">Add Loan Row</button></div>
            <table class="month-table" id="assetDebtsTable">
                <thead><tr><th>Lender / creditor</th><th>Loan type / account no.</th><th>Amount paid from sale (Rs)</th><th>Closure status</th><th></th></tr></thead>
                <tbody id="assetDebtsTableBody"></tbody>
                <tfoot><tr><td colspan="2"><strong>Total amount applied to debt (Rs)</strong></td><td colspan="2"><input type="number" id="asset_totalAppliedToDebt" readonly placeholder="0" style="width:100%;"></td><td></td></tr></tfoot>
            </table>
            <div class="input-row"><label>Any other remarks (optional):</label><textarea id="asset_remarks" rows="2" placeholder="Optional"></textarea></div>

            <div class="section-title">8. Old previous hospital management (without failure)</div>
            <p class="note-small">Evidence of losing clientele and regular income; ran a registered hospital for years before closing to start this clinic.</p>
            <div class="input-row"><label>Note about earlier hospital closed for this clinic:</label><textarea id="previousPracticeNote" rows="3" placeholder="Previously ran Surendra Nehru Hospital, a registered private hospital in Godavarikhani (DMHO certificate attached), which I closed to invest in HOMA Clinic."></textarea></div>

            <div class="section-title">9. Hardship – No Govt Job or Pension</div>
            <p class="note-small">Loss of government job, no pension. Past government and teaching service; income depended only on private practice, which is now closed.</p>
            <div class="input-row"><label>Narrative about loss of government job and no pension:</label><textarea id="hardshipNoPensionNote" rows="4" placeholder="Example: I previously served in government and teaching posts (Civil Assistant Surgeon / Assistant Professor), but I am no longer in government service and do not receive any government salary or pension. My income depended only on private practice, which is now closed."></textarea><p class="note-small">You may choose and adapt any of the templates from the right-hand box for your hardship narrative.</p></div>
        </div>

        <div class="right-panel">
            <div class="section-title">Business Setup & Closure Evidence Checklist</div>
            <p class="note-small">Check items and select files. Files are listed in export; attach manually when emailing.</p>

            <div class="section-title">Category 1: Business Registration & Licences</div>
            <div id="ev_cat1"></div>

            <div class="section-title">Category 2: Clinic Infrastructure</div>
            <div id="ev_cat2"></div>

            <div class="section-title">Category 3: Government Permissions & Taxes</div>
            <div id="ev_cat3"></div>

            <div class="section-title">Running Expenses & Equipment</div>
            <div id="ev_cat3b"></div>

            <div class="section-title">Category 4: Marketing & Digital Presence</div>
            <div id="ev_cat4"></div>

            <div class="section-title">Professional Endorsement Certificates (30+ Events)</div>
            <div id="certificate-generator" style="margin: 12px 0; padding: 12px; background: white; border: 1px solid #e0e0e0; border-radius: 4px;">
                <div id="certificate-forms-container"></div>
                <button type="button" class="btn btn-success" id="btnAddCertificate" style="margin-top: 10px;">Add Another Certificate</button>
            </div>
            <div id="certificate-preview-container" style="display: none; margin: 12px 0; padding: 12px; background: white; border: 1px solid #e0e0e0; border-radius: 4px;"></div>
            <div id="certificate-pdf-content" style="display: none;"></div>

            <div class="section-title">Category 5: Closure Documents</div>
            <div id="ev_cat5"></div>

            <div class="section-title">Category 6: Hardship Documents</div>
            <div id="ev_cat6"></div>

            <div class="section-title">Category 8: Old previous hospital management (without failure)</div>
            <div id="ev_cat8"></div>

            <div class="section-title">Category 9: Hardship – Loss of Government Job and No Pension</div>
            <div id="ev_cat9"></div>

            <div class="hardship-suggested-box">
                <div class="section-title" style="font-size:12px;">Suggested hardship wording (for OTS emails and notes)</div>
                <div id="hardshipTemplatesList" style="margin-top:8px;"></div>
                <textarea id="hardshipTemplateDisplay" readonly rows="6" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:12px;margin-top:8px;background:#fff;resize:vertical;"></textarea>
                <button type="button" class="btn" id="btnCopyHardshipTemplate" style="margin-top:8px;">Copy text</button>
            </div>

            <div class="action-bar" style="margin-top:24px;">
                <button type="button" class="btn btn-primary" id="btnGenerate">Generate Comprehensive Evidence Package</button>
                <span id="generateStatus" style="margin-left:12px;font-size:13px;color:#2e7d32;font-weight:500;"></span>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;justify-content:center;">
                <button type="button" class="btn btn-success" id="btnExportJSON">Save as JSON</button>
                <button type="button" class="btn" id="btnExportCSV">Save as CSV</button>
                <button type="button" class="btn" id="btnExportPDF">Save as PDF</button>
            </div>
        </div>
    </div>

    <div id="pdfContent" style="position:absolute;left:-9999px;top:0;width:800px;min-height:400px;padding:20px;background:#fff;font-family:Segoe UI,sans-serif;"></div>

    <script>
    (function() {
        'use strict';
        var HARDSHIP_TEMPLATES = [
            { id: 'no_govt_pension', label: 'Loss of government job and no pension', text: 'Earlier in my career I served in government and teaching posts as a doctor, but I am no longer in government service and do not receive any government salary or pension. My income in recent years depended entirely on my private hospital and clinic practice, which has had to close, causing a severe and continuing reduction in my earnings. Despite selling assets and cutting personal expenses to repay as much as possible, I am currently unable to maintain the original instalment schedule on these loans. I am therefore requesting a reasonable one-time settlement or restructured arrangement so that I can close these obligations in a fair and sustainable manner.' },
            { id: 'closure_hospital_clinic', label: 'Closure of earlier hospital and current clinic', text: 'I previously managed a fully functional, registered hospital/clinic, which was closed in order to invest in and establish my current clinic. That investment has not produced the expected income, and the clinic has faced sustained operating losses, leading to serious cash-flow constraints. I have used the proceeds from closing the earlier hospital and subsequent income to service my debts to the maximum extent possible. I now seek a fair settlement or restructuring so that these loans can be closed in an orderly and transparent manner.' },
            { id: 'major_asset_sold', label: 'Major asset sold to repay debts', text: 'To honour my obligations in good faith, I have already sold a major personal/family asset and applied the sale proceeds towards repayment of multiple loans, as reflected in the enclosed sale deed and bank statements. After this one-time sacrifice, I no longer have comparable assets available to liquidate. Even after applying the entire sale consideration, a residual balance remains which I am presently unable to clear under the original terms. I therefore request that the remaining dues be considered for a reasonable one-time settlement or restructured plan aligned with my present repayment capacity.' },
            { id: 'health_impact', label: 'Health-related impact on earning capacity', text: 'My ability to practice medicine and manage the clinic has been significantly affected by health issues, resulting in reduced working hours and lower professional income. These medical circumstances were not anticipated at the time the loans were taken and have directly affected my capacity to meet instalments on the original schedule. I continue to work within my medical limitations and to prioritise debt repayment from whatever income is available. In view of this genuine and continuing hardship, I am requesting a pragmatic restructuring or one-time settlement that reflects my current earning capacity.' },
            { id: 'income_collapse', label: 'Collapse in clinical income and operating environment', text: 'Over the past few years there has been a substantial and sustained decline in patient footfall and clinic revenues due to adverse market and regulatory conditions beyond my control. Fixed costs for staff, rent, and compliance have remained high, while receipts from practice have fallen sharply, creating persistent operating losses. I have responded by reducing expenses wherever possible and discontinuing unviable activities, but the income is still insufficient to service the loans on their original terms. I am therefore seeking a realistic restructuring or settlement so that repayments can continue without further defaults.' },
            { id: 'good_faith_borrower', label: 'Good-faith borrower requesting OTS/restructure', text: 'Since incurring these loans I have consistently acted in good faith by making payments whenever funds were available, selling assets, and cutting personal and business expenses to reduce my liabilities. Despite these efforts, my present income is not adequate to clear the full outstanding amount under the current schedule without jeopardising essential medical practice and family needs. I wish to resolve these accounts respectfully and avoid prolonged litigation by agreeing to a fair, sustainable settlement structure. I therefore request that the lender kindly consider a one-time settlement or restructured repayment plan in line with my documented financial position.' }
        ];
        var EVIDENCE_ITEMS = {
            cat1: [
                { id: 'clinic_reg', label: 'Clinic registration certificate (DMHO/health dept)' },
                { id: 'pharmacy_lic', label: 'Pharmacy drug licence' },
                { id: 'shop_lic', label: 'Shop & Establishment / Trade licence' },
                { id: 'pan', label: 'Entity PAN card' },
                { id: 'gst_reg', label: 'GST registration certificate' }
            ],
            cat2: [
                { id: 'rent_lease', label: 'Rent/lease agreement' },
                { id: 'equipment', label: 'Equipment purchase bills (furniture, medical devices)' },
                { id: 'signage', label: 'Signage/boards/LED installation bills' },
                { id: 'software', label: 'Hospital software licence/invoice' },
                { id: 'interior', label: 'Interior/renovation bills' },
                { id: 'interior_quote', label: 'Interior quotation / bill (HOMA Clinic)', accept: '.pdf,.jpg,.jpeg,.png,.csv', help: 'Example: HOMA Clinic turnkey interior quote around Rs. 17,20,349 (ceilings, partitions, pharmacy/lab/reception furniture, bathroom, electrical, doors, painting). Photos of completed interior can be added later for court/legal pack (not required for OTS emails).' },
                { id: 'clinicPhotos', label: 'Real clinic photos (exterior/interior, before closure)', multiFile: true, internalHelp: 'Upload digital copies here. Keep color prints in physical evidence folder for court if requested. Proves clinic existed and was professionally set up.' },
                { id: 'ac_units', label: 'AC Units Installation', help: 'Upload AC quotation/invoice (Sri Mani Ent.), UPI payments, transport bill, installed photos for HOMA Clinic setup costs (~₹3L, Oct 2023). Hidden in print if empty.', hasDescription: true }
            ],
            cat3: [
                { id: 'pollution', label: 'Pollution clearance / fire safety NOC (if applicable)' },
                { id: 'it_returns', label: 'IT returns (last 3 years)' },
                { id: 'gst_receipts', label: 'GST payment receipts' },
                { id: 'prof_tax', label: 'Professional tax receipts' },
                { id: 'govtFeesReceipts', label: 'Govt fees receipts (DMHO, registration, etc.)' }
            ],
            cat3b: [
                { id: 'utilityBills', label: 'Electricity/phone/internet bills' },
                { id: 'equipmentAdvances', label: 'Equipment advances (fans, AC, chairs, fridge, beds)' },
                { id: 'pharmaMarketingReceipts', label: 'Pharma/marketing dues and receipts' },
                { id: 'cashOnlineReceipts', label: 'Cash bills/online receipts' },
                { id: 'emiBankStatements', label: 'EMI bank statements (monthly debits)', multiFile: true, internalHelp: 'Upload bank statements showing EMI debits. Post-closure EMI interest payments prove financial burden and good faith for OTS.' },
                { id: 'loanLensPack', label: 'LoanLens monthly cashflow PDFs (Feb 2024 – Jan 2025)', internalHelp: 'Optional: Combined PDF of 12 LoanLens monthly reports showing income vs EMI & expenses for each month.' }
            ],
            cat4: [
                { id: 'digital_mkt', label: 'Digital marketing bills (Google Ads, social media)' },
                { id: 'print_ads', label: 'Print ads / pamphlets' },
                { id: 'website', label: 'Website development invoice' },
                { id: 'awareness_meetings', label: 'Awareness Meetings & Flyers', help: 'Proves business promotion efforts; request certs from hosts for endorsement.', hasDescription: true, multiFile: true, descriptionPlaceholder: 'Upload flyers, Zoom invites, certificates from 30+ events (Adoni, Rajahmundry, diabetes talks). Counts as marketing spend.' },
                { id: 'onlineInfraReceipts', label: 'Online infra receipts (Vercel / Supabase / Railway)', multiFile: true, internalHelp: 'Optional: Upload hosting/database receipts showing online clinic/OTS tools. Treated as small support expenses.' }
            ],
            cat5: [
                { id: 'dmho_closure', label: 'DMHO clinic closure request letter (signed)' },
                { id: 'drug_cancel', label: 'Drug licence cancellation request (signed)' },
                { id: 'landlord_noc', label: 'Landlord closure certificate / NOC' },
                { id: 'premises_handover', label: 'Premises handover letter' },
                { id: 'sale_deed', label: 'Registered sale deed of house / major asset sold to repay debts' },
                { id: 'bank_statement_proofs', label: 'Bank statement / payment proofs showing loan repayments from sale proceeds' }
            ],
            cat6: [
                { id: 'staff_salary', label: 'Staff salary dues certificate' },
                { id: 'pharma_bills', label: 'Pharmacy/distributor overdue bills' },
                { id: 'lab_vendor', label: 'Lab/vendor dues notices' },
                { id: 'borrower_health', label: 'Borrower health certificates' },
                { id: 'spouse_health', label: 'Spouse health certificates' },
                { id: 'medical_bills', label: 'Medical bills (high expenses)' },
                { id: 'court_summons', label: 'Court summons / legal notices' }
            ],
            cat8: [
                { id: 'prev_hospital_reg', label: 'Previous hospital / clinic registration certificate (e.g., Surendra Nehru Hospital, Godavarikhani)', help: 'Use this for old practice registration closed for starting this clinic.' }
            ],
            cat9: [
                { id: 'govt_service_order', label: 'Past government appointment order (Civil Assistant Surgeon, AP Government)' },
                { id: 'teaching_hospital_cert', label: 'Teaching hospital certificate (Osmania General Hospital / Medical College)' },
                { id: 'other_govt_service_proof', label: 'Other service/relieving certificates proving no current govt job or pension' }
            ]
        };

        function getVal(id) {
            var el = document.getElementById(id);
            return el ? String(el.value || '').trim() : '';
        }
        function getNum(id) { return parseFloat(getVal(id)) || 0; }
        function getChecked(id) {
            var el = document.getElementById(id);
            return el && el.checked;
        }
        function getFileName(inputId) {
            var el = document.getElementById(inputId);
            if (!el || !el.files || el.files.length === 0) return '';
            if (el.files.length === 1) return el.files[0].name || '';
            return Array.prototype.map.call(el.files, function(f) { return f.name; }).join(', ');
        }

        function renderEvidenceCategory(catId, containerId) {
            var items = EVIDENCE_ITEMS[catId] || [];
            var container = document.getElementById(containerId);
            if (!container) return;
            var html = '';
            items.forEach(function(it) {
                var fid = 'ev_' + it.id;
                var acceptVal = it.accept || '.pdf,.jpg,.jpeg,.png,.doc,.docx,.mp4,.mov,.avi';
                var fileInputAttrs = it.multiFile ? 'multiple ' : '';
                html += '<div class="ev-item">' +
                    '<div class="cb-row"><input type="checkbox" id="chk_' + fid + '"><label for="chk_' + fid + '" style="display:inline;">' + it.label + '</label></div>' +
                    '<div class="file-row">File' + (it.multiFile ? 's' : '') + ': <input type="file" id="file_' + fid + '" ' + fileInputAttrs + 'accept="' + acceptVal + '" style="font-size:11px;max-width:200px;"> <span id="fn_' + fid + '" style="color:#666;"></span></div>' +
                    (it.hasDescription ? '<div class="file-row" style="margin-top:4px;">Description: <input type="text" id="desc_' + fid + '" placeholder="' + (it.descriptionPlaceholder || 'Short description') + '" style="font-size:11px;max-width:300px;flex:1;"></div>' : '') +
                    (it.help ? '<div class="note-small">' + it.help + '</div>' : '') +
                    (it.internalHelp ? '<div class="internal-helper note-small">' + it.internalHelp + '</div>' : '') +
                    '</div>';
            });
            container.innerHTML = html;
            items.forEach(function(it) {
                var fid = 'ev_' + it.id;
                var fileEl = document.getElementById('file_' + fid);
                var fnEl = document.getElementById('fn_' + fid);
                if (fileEl && fnEl) {
                    fileEl.addEventListener('change', function() {
                        if (it.multiFile && fileEl.files && fileEl.files.length > 0) {
                            var fileNames = Array.prototype.map.call(fileEl.files, function(f) { return f.name; }).join(', ');
                            fnEl.textContent = fileEl.files.length + ' file(s): ' + (fileNames.length > 50 ? fileNames.substring(0, 50) + '...' : fileNames);
                        } else {
                            fnEl.textContent = fileEl.files && fileEl.files.length ? (fileEl.files.length === 1 ? fileEl.files[0].name : fileEl.files.length + ' files') : '';
                        }
                        if (it.id === 'awareness_meetings') updateAwarenessMeetingsPrintVisibility();
                        if (it.id === 'ac_units') updateAcUnitsPrintVisibility();
                    });
                }
                if (it.id === 'ac_units') {
                    var chkEl = document.getElementById('chk_' + fid);
                    var descEl = document.getElementById('desc_' + fid);
                    if (chkEl) chkEl.addEventListener('change', updateAcUnitsPrintVisibility);
                    if (descEl) descEl.addEventListener('input', updateAcUnitsPrintVisibility);
                }
                if (it.id === 'awareness_meetings') {
                    var chkEl = document.getElementById('chk_' + fid);
                    var descEl = document.getElementById('desc_' + fid);
                    if (chkEl) chkEl.addEventListener('change', updateAwarenessMeetingsPrintVisibility);
                    if (descEl) descEl.addEventListener('input', updateAwarenessMeetingsPrintVisibility);
                }
            });
            updateAcUnitsPrintVisibility();
            updateAwarenessMeetingsPrintVisibility();
        }
        
        function updateAcUnitsPrintVisibility() {
            var fid = 'ev_ac_units';
            var chkEl = document.getElementById('chk_' + fid);
            var fileEl = document.getElementById('file_' + fid);
            var descEl = document.getElementById('desc_' + fid);
            var evItem = chkEl ? chkEl.closest('.ev-item') : null;
            if (evItem) {
                var isChecked = chkEl && chkEl.checked;
                var hasFile = fileEl && fileEl.files && fileEl.files.length > 0;
                var hasDesc = descEl && descEl.value && descEl.value.trim() !== '';
                if (!isChecked && !hasFile && !hasDesc) {
                    evItem.setAttribute('data-ac-units-empty', 'true');
                } else {
                    evItem.removeAttribute('data-ac-units-empty');
                }
            }
        }
        
        function updateAwarenessMeetingsPrintVisibility() {
            var fid = 'ev_awareness_meetings';
            var chkEl = document.getElementById('chk_' + fid);
            var fileEl = document.getElementById('file_' + fid);
            var descEl = document.getElementById('desc_' + fid);
            var evItem = chkEl ? chkEl.closest('.ev-item') : null;
            if (evItem) {
                var isChecked = chkEl && chkEl.checked;
                var hasFile = fileEl && fileEl.files && fileEl.files.length > 0;
                var hasDesc = descEl && descEl.value && descEl.value.trim() !== '';
                if (!isChecked && !hasFile && !hasDesc) {
                    evItem.setAttribute('data-awareness-meetings-empty', 'true');
                } else {
                    evItem.removeAttribute('data-awareness-meetings-empty');
                }
            }
        }

        var MONTHLY_LENS_DEFAULT_MONTHS = ['Feb 2024','Mar 2024','Apr 2024','May 2024','Jun 2024','Jul 2024','Aug 2024','Sep 2024','Oct 2024','Nov 2024','Dec 2024','Jan 2025'];
        function initMonthlyLensTable() {
            var tbody = document.getElementById('monthlyLensTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            for (var i = 0; i < 12; i++) {
                var tr = document.createElement('tr');
                tr.setAttribute('data-lens-index', i);
                tr.innerHTML = '<td><input type="text" id="monthlyLens_' + i + '_month" class="monthlyLens-month" value="' + (MONTHLY_LENS_DEFAULT_MONTHS[i] || '') + '" style="width:90px;"></td>' +
                    '<td><input type="number" id="monthlyLens_' + i + '_income" class="monthlyLens-income" min="0" step="1" placeholder="0" style="width:80px;"></td>' +
                    '<td><input type="number" id="monthlyLens_' + i + '_emi" class="monthlyLens-emi" min="0" step="1" placeholder="0" style="width:80px;"></td>' +
                    '<td><input type="number" id="monthlyLens_' + i + '_rent" class="monthlyLens-rent" min="0" step="1" placeholder="0" style="width:80px;"></td>' +
                    '<td><input type="number" id="monthlyLens_' + i + '_other" class="monthlyLens-other" min="0" step="1" placeholder="0" style="width:80px;"></td>' +
                    '<td id="monthlyLens_' + i + '_net" class="monthlyLens-net" style="min-width:70px;font-weight:500;">0</td>';
                tbody.appendChild(tr);
                (function(idx) {
                    var incomeEl = document.getElementById('monthlyLens_' + idx + '_income');
                    var emiEl = document.getElementById('monthlyLens_' + idx + '_emi');
                    var rentEl = document.getElementById('monthlyLens_' + idx + '_rent');
                    var otherEl = document.getElementById('monthlyLens_' + idx + '_other');
                    var netEl = document.getElementById('monthlyLens_' + idx + '_net');
                    function updateNet() {
                        if (!netEl) return;
                        var income = parseFloat(incomeEl && incomeEl.value) || 0;
                        var emi = parseFloat(emiEl && emiEl.value) || 0;
                        var rent = parseFloat(rentEl && rentEl.value) || 0;
                        var other = parseFloat(otherEl && otherEl.value) || 0;
                        var net = income - (emi + rent + other);
                        netEl.textContent = net.toLocaleString('en-IN');
                        netEl.style.color = net < 0 ? '#d32f2f' : '';
                    }
                    if (incomeEl) incomeEl.addEventListener('input', updateNet);
                    if (emiEl) emiEl.addEventListener('input', updateNet);
                    if (rentEl) rentEl.addEventListener('input', updateNet);
                    if (otherEl) otherEl.addEventListener('input', updateNet);
                    updateNet();
                })(i);
            }
        }
        function collectMonthlyLensData() {
            var arr = [];
            for (var i = 0; i < 12; i++) {
                var income = getNum('monthlyLens_' + i + '_income');
                var emi = getNum('monthlyLens_' + i + '_emi');
                var rent = getNum('monthlyLens_' + i + '_rent');
                var other = getNum('monthlyLens_' + i + '_other');
                var net = income - (emi + rent + other);
                arr.push({
                    month: getVal('monthlyLens_' + i + '_month') || (MONTHLY_LENS_DEFAULT_MONTHS[i] || ''),
                    income: income,
                    emi: emi,
                    rent: rent,
                    other: other,
                    net: net
                });
            }
            return arr;
        }

        window._certificateCounter = 1;
        window._generatedCertificates = [];

        function createCertificateForm(certNo) {
            var formId = 'cert_form_' + certNo;
            var formHtml = '<div class="certificate-form" id="' + formId + '">' +
                '<h4>Certificate #' + certNo + '</h4>' +
                '<div class="input-row"><label>Event Date:</label><input type="date" id="cert_date_' + certNo + '"></div>' +
                '<div class="input-row"><label>Venue:</label><input type="text" id="cert_venue_' + certNo + '" placeholder="e.g., Adoni, Rajahmundry"></div>' +
                '<div class="input-row"><label>Date & Time:</label><input type="text" id="cert_datetime_' + certNo + '" placeholder="e.g., 15 Oct 2023, 10:00 AM - 2:00 PM"></div>' +
                '<div class="input-row"><label>Organizer Name:</label><input type="text" id="cert_organizer_' + certNo + '" placeholder="Name of organizer"></div>' +
                '<div class="input-row"><label>Organizer Phone:</label><input type="text" id="cert_phone_' + certNo + '" placeholder="Phone number"></div>' +
                '<div class="input-row"><label>Organizer Email:</label><input type="email" id="cert_email_' + certNo + '" placeholder="Email address"></div>' +
                '<div class="input-row"><label>Organizer Center/Organization:</label><input type="text" id="cert_center_' + certNo + '" placeholder="Organization name"></div>' +
                '<div style="margin-top: 10px;">' +
                '<button type="button" class="btn" onclick="previewCertificate(' + certNo + ')">Preview</button> ' +
                '<button type="button" class="btn btn-success" onclick="generateCertificatePDF(' + certNo + ')">Generate & Download PDF</button> ' +
                '<button type="button" class="btn" onclick="removeCertificateForm(' + certNo + ')" style="background: #c62828;">Remove</button>' +
                '</div>' +
                '</div>';
            return formHtml;
        }

        function addCertificateForm() {
            var certNo = window._certificateCounter++;
            var container = document.getElementById('certificate-forms-container');
            if (container) {
                container.insertAdjacentHTML('beforeend', createCertificateForm(certNo));
            }
        }

        window.removeCertificateForm = function(certNo) {
            var form = document.getElementById('cert_form_' + certNo);
            if (form) form.remove();
            window._generatedCertificates = window._generatedCertificates.filter(function(c) { return c.certNo !== certNo; });
        };

        function getCertVal(certNo, field) {
            var el = document.getElementById('cert_' + field + '_' + certNo);
            return el ? String(el.value || '').trim() : '';
        }

        function generateCertificateHTML(certNo) {
            var eventDate = getCertVal(certNo, 'date');
            var venue = getCertVal(certNo, 'venue');
            var datetime = getCertVal(certNo, 'datetime');
            var organizer = getCertVal(certNo, 'organizer');
            var phone = getCertVal(certNo, 'phone');
            var email = getCertVal(certNo, 'email');
            var center = getCertVal(certNo, 'center');
            
            var issueDate = new Date().toLocaleDateString('en-GB');
            var certNoStr = 'CERT-' + String(certNo).padStart(4, '0');
            
            var html = '<div class="certificate" style="font-family: \'Times New Roman\', serif; max-width: 800px; margin: 0 auto; padding: 40px; border: 2px solid #000; background: white;">' +
                '<div style="text-align: center; margin-bottom: 30px;">' +
                '<h1 style="font-size: 24pt; font-weight: bold; color: #1a3c5e; margin: 0;">CERTIFICATE OF PARTICIPATION & PROFESSIONAL ENDORSEMENT</h1>' +
                '</div>' +
                '<table style="width: 100%; margin-bottom: 30px;">' +
                '<tr><td><strong>Certificate No.:</strong> ' + certNoStr + '</td><td style="text-align: right;"><strong>Date:</strong> ' + issueDate + '</td></tr>' +
                '</table>' +
                '<p style="font-size: 14pt; margin-bottom: 20px;"><strong>Event:</strong> Awareness Symposium on Metabolic Syndrome, Diabetes Reversal, and Cardiovascular Risk Prevention</p>' +
                '<p><strong>Venue:</strong> ' + (venue || '[VENUE]') + '</p>' +
                '<p><strong>Date & Time:</strong> ' + (datetime || '[EVENT_DATE_TIME]') + '</p>' +
                '<p><strong>Organized by:</strong> ' + (organizer || '[ORGANIZER]') + '</p>' +
                '<div style="margin: 40px 0; padding: 20px; border-left: 4px solid #1a3c5e;">' +
                '<p style="font-size: 16pt; font-weight: bold; margin-bottom: 15px;">This is to certify that</p>' +
                '<p style="font-size: 18pt; font-weight: bold; color: #1a3c5e; margin: 10px 0;">' +
                'Dr. M. Surendra Nehru, MD (Medicine)<br>' +
                'Senior Consultant Physician | Insulin Metabolism Specialist<br>' +
                'HOMA Health Care Center, Gachibowli, Hyderabad' +
                '</p>' +
                '<p style="font-size: 14pt; line-height: 1.6; margin-top: 20px;">' +
                'participated as <strong>Guest Expert Speaker</strong> and delivered an authoritative presentation on evidence-based diabetes reversal strategies, insulin resistance management, and heart attack prevention to an audience of <strong>50+ healthcare professionals, patients, and community members.</strong>' +
                '</p>' +
                '<p style="font-size: 14pt; line-height: 1.6;">' +
                'Dr. Nehru\'s insights significantly advanced public health awareness and demonstrated his commitment to clinical excellence, directly supporting HOMA Clinic\'s mission of metabolic health transformation.' +
                '</p>' +
                '<p style="font-size: 14pt; font-weight: bold; margin-top: 20px;">' +
                'We wholeheartedly endorse Dr. Nehru\'s professional expertise and contributions to medical education.' +
                '</p>' +
                '</div>' +
                '<div style="margin-top: 50px;">' +
                '<p style="font-size: 14pt;"><strong>Issued by:</strong></p>' +
                '<div style="margin-top: 30px; text-align: center;">' +
                '________________________________<br>' +
                '<strong>' + (organizer || '[ORGANIZER NAME]') + '</strong><br>' +
                '<em>Director/Convener</em><br>' +
                (center || '[ORGANIZER_CENTER]') + '<br>' +
                'Phone: ' + (phone || '[PHONE]') + ' | Email: ' + (email || '[EMAIL]') +
                '</div>' +
                '<div style="margin-top: 40px; text-align: center;">' +
                '<strong>Official Seal/Stamp:</strong> ___________________<br>' +
                '<strong>Date:</strong> ' + (eventDate ? new Date(eventDate).toLocaleDateString('en-GB') : '[DD/MM/YYYY]') +
                '</div>' +
                '</div>' +
                '</div>';
            return html;
        }

        window.previewCertificate = function(certNo) {
            var html = generateCertificateHTML(certNo);
            var container = document.getElementById('certificate-preview-container');
            if (container) {
                container.innerHTML = '<h4>Certificate Preview</h4><div class="certificate-preview">' + html + '</div>';
                container.style.display = 'block';
                container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        };

        window.generateCertificatePDF = function(certNo) {
            if (typeof html2pdf === 'undefined') {
                alert('PDF library loading... Please wait a moment and try again.');
                return;
            }
            
            var venue = getCertVal(certNo, 'venue');
            var certNoStr = 'CERT-' + String(certNo).padStart(4, '0');
            var filename = 'Cert_' + certNoStr + '_' + (venue || 'Event').replace(/[^a-zA-Z0-9]/g, '_') + '.pdf';
            
            var html = generateCertificateHTML(certNo);
            var content = document.getElementById('certificate-pdf-content');
            if (!content) {
                content = document.createElement('div');
                content.id = 'certificate-pdf-content';
                content.style.display = 'none';
                document.body.appendChild(content);
            }
            content.innerHTML = html;
            
            var opt = {
                margin: 10,
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, letterRendering: true, logging: false },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(content).save().then(function() {
                var certData = {
                    certNo: certNo,
                    certNoStr: certNoStr,
                    venue: venue,
                    organizer: getCertVal(certNo, 'organizer'),
                    filename: filename,
                    eventDate: getCertVal(certNo, 'date'),
                    datetime: getCertVal(certNo, 'datetime'),
                    phone: getCertVal(certNo, 'phone'),
                    email: getCertVal(certNo, 'email'),
                    center: getCertVal(certNo, 'center')
                };
                
                if (!window._generatedCertificates) window._generatedCertificates = [];
                var existing = window._generatedCertificates.findIndex(function(c) { return c.certNo === certNo; });
                if (existing >= 0) {
                    window._generatedCertificates[existing] = certData;
                } else {
                    window._generatedCertificates.push(certData);
                }
                
                var evId = 'ev_awareness_meetings';
                var chkEl = document.getElementById('chk_' + evId);
                if (chkEl) chkEl.checked = true;
                
                alert('Certificate PDF generated: ' + filename + '\n\nCertificate saved to evidence list. You can generate more certificates using "Add Another Certificate".');
            }).catch(function(err) {
                alert('PDF generation failed: ' + (err && err.message ? err.message : 'Unknown error'));
            });
        }

        function renderHardshipTemplates() {
            var listEl = document.getElementById('hardshipTemplatesList');
            var displayEl = document.getElementById('hardshipTemplateDisplay');
            if (!listEl || !displayEl) return;
            var html = '';
            HARDSHIP_TEMPLATES.forEach(function(t) {
                html += '<button type="button" class="hardship-template-label" data-template-id="' + t.id + '">' + t.label + '</button>';
            });
            listEl.innerHTML = html;
            listEl.querySelectorAll('.hardship-template-label').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var id = btn.getAttribute('data-template-id');
                    var t = HARDSHIP_TEMPLATES.filter(function(x) { return x.id === id; })[0];
                    if (t) displayEl.value = t.text;
                });
            });
            if (HARDSHIP_TEMPLATES.length > 0) displayEl.value = HARDSHIP_TEMPLATES[0].text;
        }

        function recalcInvestment() {
            var ids = ['inv_registration','inv_rent','inv_equipment','inv_signage','inv_software','inv_medicine'];
            var sum = ids.reduce(function(a, id) { return a + getNum(id); }, 0);
            var el = document.getElementById('inv_total');
            if (el) el.value = Math.round(sum);
        }
        function recalcLoan() {
            var emi = getNum('loan_emi');
            var months = getNum('loan_monthsPaid');
            var os = getNum('loan_outstanding');
            var pct = getNum('loan_otsPct') || 70;
            var totalPaid = Math.round(emi * months);
            var otsAmt = Math.round(os * (pct / 100));
            var savings = os - otsAmt;
            var pa = document.getElementById('loan_totalPaid'); if (pa) pa.value = totalPaid;
            var oa = document.getElementById('loan_otsAmt'); if (oa) oa.value = otsAmt;
            var sv = document.getElementById('loan_savings'); if (sv) sv.value = Math.round(savings);
        }
        function recalcMonths() {
            var rows = document.querySelectorAll('#monthTableBody tr');
            var totRev = 0, totExp = 0;
            rows.forEach(function(tr) {
                var rev = parseFloat(tr.querySelector('input.rev') && tr.querySelector('input.rev').value) || 0;
                var exp = parseFloat(tr.querySelector('input.exp') && tr.querySelector('input.exp').value) || 0;
                totRev += rev; totExp += exp;
                var net = rev - exp;
                var netEl = tr.querySelector('.net');
                if (netEl) netEl.textContent = net.toLocaleString();
            });
            var totNet = totRev - totExp;
            var r = document.getElementById('totRevenue'); if (r) r.textContent = totRev.toLocaleString();
            var e = document.getElementById('totExpenses'); if (e) e.textContent = totExp.toLocaleString();
            var n = document.getElementById('totNet'); if (n) n.textContent = totNet.toLocaleString();
        }

        function addMonthRow() {
            var tbody = document.getElementById('monthTableBody');
            if (!tbody) return;
            var m = tbody.querySelectorAll('tr').length + 1;
            var tr = document.createElement('tr');
            tr.innerHTML = '<td><input type="text" placeholder="e.g. Jan-2024" class="month" size="10"></td>' +
                '<td><input type="number" class="rev" min="0" placeholder="0" size="8"></td>' +
                '<td><input type="number" class="exp" min="0" placeholder="0" size="8"></td>' +
                '<td class="net">0</td>' +
                '<td><button type="button" class="btn" style="padding:2px 6px;font-size:11px;" data-remove>Remove</button></td>';
            tbody.appendChild(tr);
            tr.querySelectorAll('input.rev, input.exp').forEach(function(inp) {
                inp.addEventListener('input', recalcMonths);
            });
            tr.querySelector('[data-remove]').addEventListener('click', function() {
                tr.remove();
                recalcMonths();
            });
            recalcMonths();
        }

        function addEmiRow() {
            var tbody = document.getElementById('emiTrackerTableBody');
            if (!tbody) return;
            var tr = document.createElement('tr');
            tr.className = 'emi-tracker-row';
            var statusOpts = '<option value="">--</option><option value="Pre-Closure">Pre-Closure</option><option value="Post-Closure">Post-Closure (Loss)</option>';
            tr.innerHTML = '<td><input type="text" class="emi-month" placeholder="e.g. Feb-2023" size="10"></td>' +
                '<td><input type="number" class="emi-principal" min="0" placeholder="0" size="8"></td>' +
                '<td><input type="number" class="emi-interest" min="0" placeholder="0" size="8"></td>' +
                '<td class="emi-total">0</td>' +
                '<td><select class="emi-status" style="width:100%;">' + statusOpts + '</select></td>' +
                '<td><button type="button" class="btn" style="padding:2px 6px;font-size:11px;" data-remove>Remove</button></td>';
            tbody.appendChild(tr);
            tr.querySelectorAll('.emi-principal, .emi-interest').forEach(function(inp) {
                inp.addEventListener('input', recalcEmiTracker);
            });
            tr.querySelector('.emi-status').addEventListener('change', recalcEmiTracker);
            tr.querySelector('[data-remove]').addEventListener('click', function() {
                tr.remove();
                recalcEmiTracker();
            });
            recalcEmiTracker();
        }

        function recalcEmiTracker() {
            var rows = document.querySelectorAll('#emiTrackerTableBody tr.emi-tracker-row');
            var totPrincipal = 0, totInterest = 0, totEmi = 0, postClosureInterest = 0;
            rows.forEach(function(tr) {
                var principal = parseFloat(tr.querySelector('.emi-principal') && tr.querySelector('.emi-principal').value) || 0;
                var interest = parseFloat(tr.querySelector('.emi-interest') && tr.querySelector('.emi-interest').value) || 0;
                var status = (tr.querySelector('.emi-status') && tr.querySelector('.emi-status').value) || '';
                var total = principal + interest;
                totPrincipal += principal;
                totInterest += interest;
                totEmi += total;
                if (status === 'Post-Closure') postClosureInterest += interest;
                var totalEl = tr.querySelector('.emi-total');
                if (totalEl) totalEl.textContent = total.toLocaleString();
            });
            var tp = document.getElementById('totEmiPrincipal'); if (tp) tp.textContent = totPrincipal.toLocaleString();
            var ti = document.getElementById('totEmiInterest'); if (ti) ti.textContent = totInterest.toLocaleString();
            var te = document.getElementById('totEmi'); if (te) te.textContent = totEmi.toLocaleString();
            var pc = document.getElementById('postClosureInterest'); if (pc) pc.textContent = 'Rs ' + postClosureInterest.toLocaleString();
        }

        function addAssetDebtRow(rowData) {
            var tbody = document.getElementById('assetDebtsTableBody');
            if (!tbody) return;
            var tr = document.createElement('tr');
            tr.className = 'asset-debt-row';
            var opts = '<option value="">--</option><option value="CLOSED">CLOSED</option><option value="PART-PAID">PART-PAID</option><option value="OTS PENDING">OTS PENDING</option>';
            tr.innerHTML = '<td><input type="text" class="asset-lender" placeholder="e.g. Bajaj Finance" style="width:100%;"></td>' +
                '<td><input type="text" class="asset-loanAccount" placeholder="Account / loan ref" style="width:100%;"></td>' +
                '<td><input type="number" class="asset-amount" min="0" placeholder="0" style="width:100%;"></td>' +
                '<td><select class="asset-status" style="width:100%;">' + opts + '</select></td>' +
                '<td><button type="button" class="btn" style="padding:2px 6px;font-size:11px;" data-remove>Remove</button></td>';
            tbody.appendChild(tr);
            if (rowData) {
                var lender = tr.querySelector('.asset-lender'); if (lender) lender.value = rowData.lender || '';
                var acct = tr.querySelector('.asset-loanAccount'); if (acct) acct.value = rowData.loanAccount || '';
                var amt = tr.querySelector('.asset-amount'); if (amt) amt.value = rowData.amountFromSale || '';
                var st = tr.querySelector('.asset-status'); if (st) st.value = rowData.closureStatus || '';
            }
            tr.querySelectorAll('.asset-amount').forEach(function(inp) {
                inp.addEventListener('input', recalcAssetDebtsTotal);
            });
            tr.querySelector('[data-remove]').addEventListener('click', function() {
                tr.remove();
                recalcAssetDebtsTotal();
            });
            recalcAssetDebtsTotal();
        }

        function recalcAssetDebtsTotal() {
            var sum = 0;
            document.querySelectorAll('#assetDebtsTableBody tr.asset-debt-row').forEach(function(tr) {
                var inp = tr.querySelector('input.asset-amount');
                sum += parseFloat(inp && inp.value) || 0;
            });
            var el = document.getElementById('asset_totalAppliedToDebt');
            if (el) el.value = Math.round(sum);
        }

        // Monthly Clinic Loss Calculator Functions
        var MONTHLY_LOSS_CATEGORIES = [
            'Staff Salary',
            'Travel (Rajahmundry/Adoni/Khammam meetings)',
            'Camps/Lectures (certificates attached)',
            'Phone/Telephone Bills',
            'GST/Compliance',
            'Fuel/Transport',
            'Online Ads (Google Ads bills)',
            'Practo Bills',
            'Maintenance/Supplies (AC, etc.)',
            'Lab Dues/Cleaning (exclude rent)'
        ];
        var monthlyLossData = {}; // { month: [{ date, category, description, income, expense }] }

        function addMonthlyLossRow() {
            var monthSelect = document.getElementById('monthlyLoss_month');
            var month = monthSelect ? monthSelect.value : '';
            if (!month) {
                alert('Please select a month first.');
                return;
            }
            var tbody = document.getElementById('monthlyLossTableBody');
            var table = document.getElementById('monthlyLossTable');
            if (!tbody || !table) return;
            
            table.style.display = 'table';
            var tr = document.createElement('tr');
            tr.className = 'monthly-loss-row';
            tr.setAttribute('data-month', month);
            
            var categoryOptions = '<option value="">-- Select --</option>';
            MONTHLY_LOSS_CATEGORIES.forEach(function(cat) {
                categoryOptions += '<option value="' + cat + '">' + cat + '</option>';
            });
            categoryOptions += '<option value="__CUSTOM__">[Custom]</option>';
            
            var currentDate = new Date();
            var year = month.includes('24') ? 2024 : (month.includes('25') ? 2025 : 2026);
            var monthNum = getMonthNumber(month);
            var defaultDate = year + '-' + String(monthNum).padStart(2, '0') + '-15';
            
            tr.innerHTML = '<td><input type="date" class="ml-date" value="' + defaultDate + '" style="width:120px;"></td>' +
                '<td><select class="ml-category" style="width:200px;">' + categoryOptions + '</select>' +
                '<input type="text" class="ml-category-custom" placeholder="Custom category" style="width:180px;display:none;margin-top:4px;"></td>' +
                '<td><input type="text" class="ml-description" placeholder="Description" style="width:200px;"></td>' +
                '<td><input type="number" class="ml-income" min="0" placeholder="0" step="0.01" style="width:100px;"></td>' +
                '<td><input type="number" class="ml-expense" min="0" placeholder="0" step="0.01" style="width:100px;"></td>' +
                '<td class="ml-running-balance">0</td>' +
                '<td><button type="button" class="btn" style="padding:2px 6px;font-size:11px;" data-remove>Remove</button></td>';
            
            tbody.appendChild(tr);
            
            var categorySelect = tr.querySelector('.ml-category');
            var customInput = tr.querySelector('.ml-category-custom');
            categorySelect.addEventListener('change', function() {
                if (this.value === '__CUSTOM__') {
                    customInput.style.display = 'block';
                } else {
                    customInput.style.display = 'none';
                    customInput.value = '';
                }
            });
            
            tr.querySelectorAll('.ml-income, .ml-expense').forEach(function(inp) {
                inp.addEventListener('input', function() {
                    recalcMonthlyLossRow(tr);
                    recalcMonthlyLossTotals(month);
                });
            });
            
            tr.querySelector('[data-remove]').addEventListener('click', function() {
                tr.remove();
                recalcMonthlyLossTotals(month);
                updateMonthlyLossSummary();
            });
            
            recalcMonthlyLossRow(tr);
            recalcMonthlyLossTotals(month);
        }

        function getMonthNumber(monthStr) {
            var months = { 'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4, 'May': 5, 'Jun': 6, 'Jul': 7, 'Aug': 8, 'Sep': 9, 'Oct': 10, 'Nov': 11, 'Dec': 12 };
            var m = monthStr.substring(0, 3);
            return months[m] || 1;
        }

        function recalcMonthlyLossRow(tr) {
            var income = parseFloat(tr.querySelector('.ml-income') && tr.querySelector('.ml-income').value) || 0;
            var expense = parseFloat(tr.querySelector('.ml-expense') && tr.querySelector('.ml-expense').value) || 0;
            var runningBalance = expense - income;
            var balanceEl = tr.querySelector('.ml-running-balance');
            if (balanceEl) {
                balanceEl.textContent = runningBalance.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });
                balanceEl.style.color = runningBalance < 0 ? '#d32f2f' : (runningBalance > 0 ? '#2e7d32' : '#666');
            }
        }

        function recalcMonthlyLossTotals(month) {
            var rows = document.querySelectorAll('#monthlyLossTableBody tr[data-month="' + month + '"]');
            var totalIncome = 0, totalExpense = 0;
            rows.forEach(function(tr) {
                var income = parseFloat(tr.querySelector('.ml-income') && tr.querySelector('.ml-income').value) || 0;
                var expense = parseFloat(tr.querySelector('.ml-expense') && tr.querySelector('.ml-expense').value) || 0;
                totalIncome += income;
                totalExpense += expense;
            });
            var netLoss = totalExpense - totalIncome;
            var incomeEl = document.getElementById('monthlyLoss_totalIncome');
            var expenseEl = document.getElementById('monthlyLoss_totalExpense');
            var netEl = document.getElementById('monthlyLoss_netLoss');
            if (incomeEl) incomeEl.textContent = totalIncome.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });
            if (expenseEl) expenseEl.textContent = totalExpense.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });
            if (netEl) {
                netEl.textContent = netLoss.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });
                netEl.style.color = netLoss < 0 ? '#d32f2f' : (netLoss > 0 ? '#2e7d32' : '#666');
            }
        }

        function calculateMonthlyLoss() {
            var monthSelect = document.getElementById('monthlyLoss_month');
            var month = monthSelect ? monthSelect.value : '';
            if (!month) {
                alert('Please select a month first.');
                return;
            }
            recalcMonthlyLossTotals(month);
            updateMonthlyLossSummary();
        }

        function updateMonthlyLossSummary() {
            var summaryBody = document.getElementById('monthlyLossSummaryBody');
            var summaryContainer = document.getElementById('monthlyLossSummaryContainer');
            if (!summaryBody || !summaryContainer) return;
            
            summaryBody.innerHTML = '';
            var allMonths = ['Feb24','Mar24','Apr24','May24','Jun24','Jul24','Aug24','Sep24','Oct24','Nov24','Dec24','Jan25','Feb25','Mar25','Apr25','May25','Jun25','Jul25','Aug25','Sep25','Oct25','Nov25','Dec25','Jan26','Feb26'];
            var cumulativeLoss = 0;
            var hasData = false;
            
            allMonths.forEach(function(month) {
                var rows = document.querySelectorAll('#monthlyLossTableBody tr[data-month="' + month + '"]');
                if (rows.length === 0) return;
                
                var totalIncome = 0, totalExpense = 0;
                rows.forEach(function(tr) {
                    var income = parseFloat(tr.querySelector('.ml-income') && tr.querySelector('.ml-income').value) || 0;
                    var expense = parseFloat(tr.querySelector('.ml-expense') && tr.querySelector('.ml-expense').value) || 0;
                    totalIncome += income;
                    totalExpense += expense;
                });
                var netLoss = totalExpense - totalIncome;
                cumulativeLoss += netLoss;
                hasData = true;
                
                var tr = document.createElement('tr');
                var isClosure = month >= 'Nov24';
                tr.innerHTML = '<td>' + month + (isClosure ? ' <span style="color:#d32f2f;font-size:11px;">(Closure)</span>' : '') + '</td>' +
                    '<td>' + totalExpense.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 }) + '</td>' +
                    '<td>' + totalIncome.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 }) + '</td>' +
                    '<td style="color:' + (netLoss < 0 ? '#d32f2f' : '#2e7d32') + ';">' + netLoss.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 }) + '</td>' +
                    '<td style="color:#d32f2f;font-weight:bold;">' + cumulativeLoss.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 }) + '</td>';
                summaryBody.appendChild(tr);
            });
            
            if (hasData) {
                summaryContainer.style.display = 'block';
            } else {
                summaryContainer.style.display = 'none';
            }
        }

        // Monthly Expense Tracker Functions
        function initExpenseTrackerTable(month) {
            var tbody = document.getElementById('expenseTrackerTableBody');
            var table = document.getElementById('expenseTrackerTable');
            if (!tbody || !table) return;
            
            tbody.innerHTML = '';
            var year = month.includes('24') ? 2024 : (month.includes('25') ? 2025 : 2026);
            var monthNum = getMonthNumber(month);
            var defaultDate = year + '-' + String(monthNum).padStart(2, '0') + '-01';
            
            EXPENSE_TRACKER_CATEGORIES.forEach(function(category, idx) {
                var tr = document.createElement('tr');
                tr.className = 'expense-tracker-row';
                tr.setAttribute('data-month', month);
                var dateValue = defaultDate;
                if (idx > 0) {
                    var dateObj = new Date(year, monthNum - 1, 1 + idx);
                    dateValue = dateObj.getFullYear() + '-' + String(dateObj.getMonth() + 1).padStart(2, '0') + '-' + String(dateObj.getDate()).padStart(2, '0');
                }
                tr.innerHTML = '<td><input type="date" class="et-date" value="' + dateValue + '" style="width:120px;"></td>' +
                    '<td>' + category + '</td>' +
                    '<td><input type="number" class="et-expense" min="0" placeholder="0" step="0.01" style="width:120px;"></td>';
                tbody.appendChild(tr);
                
                tr.querySelector('.et-expense').addEventListener('input', function() {
                    recalcExpenseTrackerTotals(month);
                    updateExpenseTrackerSummary();
                });
            });
            
            table.style.display = 'table';
            recalcExpenseTrackerTotals(month);
            updateExpenseTrackerSummary();
        }

        function recalcExpenseTrackerTotals(month) {
            var rows = document.querySelectorAll('#expenseTrackerTableBody tr[data-month="' + month + '"]');
            var totalExpense = 0;
            rows.forEach(function(tr) {
                var expense = parseFloat(tr.querySelector('.et-expense') && tr.querySelector('.et-expense').value) || 0;
                totalExpense += expense;
            });
            var netLoss = totalExpense; // Income always zero
            var expenseEl = document.getElementById('expenseTracker_totalExpense');
            var netEl = document.getElementById('expenseTracker_netLoss');
            if (expenseEl) expenseEl.textContent = totalExpense.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });
            if (netEl) netEl.textContent = netLoss.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });
        }

        function calculateExpenseTracker() {
            var monthSelect = document.getElementById('expenseTracker_month');
            var month = monthSelect ? monthSelect.value : '';
            if (!month) {
                alert('Please select a month first.');
                return;
            }
            initExpenseTrackerTable(month);
        }

        function updateExpenseTrackerSummary() {
            var summaryBody = document.getElementById('expenseTrackerSummaryBody');
            var summaryContainer = document.getElementById('expenseTrackerSummaryContainer');
            if (!summaryBody || !summaryContainer) return;
            
            summaryBody.innerHTML = '';
            var allMonths = ['Feb24','Mar24','Apr24','May24','Jun24','Jul24','Aug24','Sep24','Oct24','Nov24','Dec24','Jan25','Feb25','Mar25','Apr25','May25','Jun25','Jul25','Aug25','Sep25','Oct25','Nov25','Dec25','Jan26','Feb26'];
            var cumulativeLoss = 0;
            var hasData = false;
            
            allMonths.forEach(function(month) {
                var rows = document.querySelectorAll('#expenseTrackerTableBody tr[data-month="' + month + '"]');
                if (rows.length === 0) return;
                
                var totalExpense = 0;
                rows.forEach(function(tr) {
                    var expense = parseFloat(tr.querySelector('.et-expense') && tr.querySelector('.et-expense').value) || 0;
                    totalExpense += expense;
                });
                var netLoss = totalExpense; // Income always zero
                cumulativeLoss += netLoss;
                hasData = true;
                
                var tr = document.createElement('tr');
                tr.innerHTML = '<td>' + month + '</td>' +
                    '<td>₹' + totalExpense.toLocaleString('en-IN') + '</td>' +
                    '<td style="color:#d32f2f;">₹' + netLoss.toLocaleString('en-IN') + '</td>' +
                    '<td style="color:#d32f2f;font-weight:bold;">₹' + cumulativeLoss.toLocaleString('en-IN') + '</td>';
                summaryBody.appendChild(tr);
            });
            
            if (hasData) {
                summaryContainer.style.display = 'block';
            } else {
                summaryContainer.style.display = 'none';
            }
        }

        function exportExpenseTracker() {
            var monthSelect = document.getElementById('expenseTracker_month');
            var month = monthSelect ? monthSelect.value : '';
            if (!month) {
                alert('Please select a month first.');
                return;
            }
            var rows = document.querySelectorAll('#expenseTrackerTableBody tr[data-month="' + month + '"]');
            if (rows.length === 0) {
                alert('No data to export. Please enter expenses first.');
                return;
            }
            
            var csvLines = ['Date,Category,Expense (Rs)'];
            var totalExpense = 0;
            rows.forEach(function(tr) {
                var date = tr.querySelector('.et-date') && tr.querySelector('.et-date').value || '';
                var category = EXPENSE_TRACKER_CATEGORIES[Array.prototype.indexOf.call(rows, tr)] || '';
                var expense = parseFloat(tr.querySelector('.et-expense') && tr.querySelector('.et-expense').value) || 0;
                totalExpense += expense;
                csvLines.push(date + ',' + category.replace(/,/g,';') + ',' + expense);
            });
            csvLines.push('Total,,' + totalExpense);
            csvLines.push('Net Loss (Income=0),,' + totalExpense);
            
            // Export CSV
            var csvBlob = new Blob([csvLines.join('\n')], { type: 'text/csv;charset=utf-8' });
            var csvLink = document.createElement('a');
            csvLink.href = URL.createObjectURL(csvBlob);
            csvLink.download = 'ClinicLosses_' + month + '.csv';
            document.body.appendChild(csvLink);
            csvLink.click();
            setTimeout(function() { document.body.removeChild(csvLink); URL.revokeObjectURL(csvLink.href); }, 100);
            
            // Export PDF
            var pdfHtml = '<div style="font-family:Segoe UI,sans-serif;padding:20px;"><h2>Monthly Expense Tracker - ' + month + '</h2>';
            pdfHtml += '<table border="1" cellpadding="6" style="border-collapse:collapse;width:100%;margin-top:16px;font-size:11px;"><tr style="background:#f5f5f5;"><th>Date</th><th>Category</th><th>Expense (Rs)</th></tr>';
            rows.forEach(function(tr) {
                var date = tr.querySelector('.et-date') && tr.querySelector('.et-date').value || '';
                var category = EXPENSE_TRACKER_CATEGORIES[Array.prototype.indexOf.call(rows, tr)] || '';
                var expense = parseFloat(tr.querySelector('.et-expense') && tr.querySelector('.et-expense').value) || 0;
                pdfHtml += '<tr><td>' + date + '</td><td>' + category + '</td><td>₹' + expense.toLocaleString('en-IN') + '</td></tr>';
            });
            pdfHtml += '<tr style="font-weight:bold;background:#f5f5f5;"><td colspan="2">Total Expense</td><td style="color:#d32f2f;">₹' + totalExpense.toLocaleString('en-IN') + '</td></tr>';
            pdfHtml += '<tr style="font-weight:bold;background:#f5f5f5;"><td colspan="2">Net Loss (Income = 0)</td><td style="color:#d32f2f;">₹' + totalExpense.toLocaleString('en-IN') + '</td></tr>';
            pdfHtml += '</table></div>';
            
            if (typeof html2pdf !== 'undefined') {
                var pdfContent = document.getElementById('pdfContent');
                if (pdfContent) {
                    pdfContent.innerHTML = pdfHtml;
                    var opt = { margin: 10, filename: 'ClinicLosses_' + month + '.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, letterRendering: true, logging: false }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
                    setTimeout(function() {
                        html2pdf().set(opt).from(pdfContent).save().then(function() {
                            pdfContent.innerHTML = '';
                        }).catch(function(err) {
                            pdfContent.innerHTML = '';
                            alert('PDF export failed. CSV exported successfully.');
                        });
                    }, 200);
                }
            } else {
                alert('PDF library not loaded. CSV exported successfully.');
            }
        }

        function exportMonthlyLosses() {
            var allMonths = ['Feb24','Mar24','Apr24','May24','Jun24','Jul24','Aug24','Sep24','Oct24','Nov24','Dec24','Jan25','Feb25','Mar25','Apr25','May25','Jun25','Jul25','Aug25','Sep25','Oct25','Nov25','Dec25','Jan26','Feb26'];
            var csvLines = ['Month,Date,Category,Description,Income (Rs),Expense (Rs),Net Loss (Rs)'];
            var monthlyLosses = [];
            var cumulativeLoss = 0;
            
            allMonths.forEach(function(month) {
                var rows = document.querySelectorAll('#monthlyLossTableBody tr[data-month="' + month + '"]');
                if (rows.length === 0) return;
                
                var monthTotalIncome = 0, monthTotalExpense = 0;
                rows.forEach(function(tr) {
                    var date = tr.querySelector('.ml-date') && tr.querySelector('.ml-date').value || '';
                    var categorySelect = tr.querySelector('.ml-category');
                    var customInput = tr.querySelector('.ml-category-custom');
                    var category = categorySelect && categorySelect.value === '__CUSTOM__' ? (customInput && customInput.value || '') : (categorySelect && categorySelect.value || '');
                    var description = tr.querySelector('.ml-description') && tr.querySelector('.ml-description').value || '';
                    var income = parseFloat(tr.querySelector('.ml-income') && tr.querySelector('.ml-income').value) || 0;
                    var expense = parseFloat(tr.querySelector('.ml-expense') && tr.querySelector('.ml-expense').value) || 0;
                    var netLoss = expense - income;
                    
                    csvLines.push(month + ',' + date + ',' + (category || '').replace(/,/g,';') + ',' + (description || '').replace(/,/g,';') + ',' + income + ',' + expense + ',' + netLoss);
                    monthTotalIncome += income;
                    monthTotalExpense += expense;
                });
                
                var monthNetLoss = monthTotalExpense - monthTotalIncome;
                cumulativeLoss += monthNetLoss;
                monthlyLosses.push({
                    month: month,
                    totalExpense: monthTotalExpense,
                    totalIncome: monthTotalIncome,
                    netLoss: monthNetLoss,
                    notes: month >= 'Nov24' ? 'Closure Phase - No Revenue' : ''
                });
            });
            
            if (monthlyLosses.length === 0) {
                alert('No monthly loss data to export. Please add data first.');
                return;
            }
            
            // Export CSV
            var csvBlob = new Blob([csvLines.join('\n')], { type: 'text/csv;charset=utf-8' });
            var csvLink = document.createElement('a');
            csvLink.href = URL.createObjectURL(csvBlob);
            csvLink.download = 'monthly-clinic-losses-' + new Date().toISOString().slice(0,10) + '.csv';
            document.body.appendChild(csvLink);
            csvLink.click();
            setTimeout(function() { document.body.removeChild(csvLink); URL.revokeObjectURL(csvLink.href); }, 100);
            
            // Export PDF
            var pdfHtml = '<div style="font-family:Segoe UI,sans-serif;padding:20px;"><h2>Monthly Clinic Expenses (Rent Excluded)</h2>';
            pdfHtml += '<p style="color:#666;font-size:12px;">Track Feb 2024-Oct 2024 (running losses) + Nov 2024-Feb 2026 (closure losses). EXCLUDE RENT. Shows ₹ outflow from Dr. Nehru\'s pocket monthly.</p>';
            pdfHtml += '<table border="1" cellpadding="6" style="border-collapse:collapse;width:100%;margin-top:16px;font-size:11px;"><tr style="background:#f5f5f5;"><th>Month</th><th>Total Expense</th><th>Income</th><th>Net Loss</th><th>Cumulative Loss</th></tr>';
            var cumLoss = 0;
            monthlyLosses.forEach(function(m) {
                cumLoss += m.netLoss;
                pdfHtml += '<tr><td>' + m.month + (m.notes ? ' <span style="color:#d32f2f;">(Closure)</span>' : '') + '</td>' +
                    '<td>₹' + m.totalExpense.toLocaleString('en-IN') + '</td>' +
                    '<td>₹' + m.totalIncome.toLocaleString('en-IN') + '</td>' +
                    '<td style="color:#d32f2f;">₹' + m.netLoss.toLocaleString('en-IN') + '</td>' +
                    '<td style="color:#d32f2f;font-weight:bold;">₹' + cumLoss.toLocaleString('en-IN') + '</td></tr>';
            });
            pdfHtml += '</table>';
            pdfHtml += '<p style="margin-top:20px;font-weight:bold;color:#d32f2f;">Cumulative Loss (Feb24-Feb26): ₹' + cumulativeLoss.toLocaleString('en-IN') + '</p>';
            pdfHtml += '</div>';
            
            if (typeof html2pdf !== 'undefined') {
                var pdfContent = document.getElementById('pdfContent');
                if (pdfContent) {
                    pdfContent.innerHTML = pdfHtml;
                    var opt = { margin: 10, filename: 'monthly-clinic-losses-' + new Date().toISOString().slice(0,10) + '.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, letterRendering: true, logging: false }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
                    setTimeout(function() {
                        html2pdf().set(opt).from(pdfContent).save().then(function() {
                            pdfContent.innerHTML = '';
                        }).catch(function(err) {
                            pdfContent.innerHTML = '';
                            alert('PDF export failed. CSV exported successfully.');
                        });
                    }, 200);
                }
            } else {
                alert('PDF library not loaded. CSV exported successfully.');
            }
        }

        function collectStep5Data() {
            var invIds = ['inv_registration','inv_rent','inv_equipment','inv_signage','inv_software','inv_medicine'];
            var investment = {};
            invIds.forEach(function(id) {
                var key = id.replace('inv_','');
                investment[key] = getNum(id);
            });
            investment.total = getNum('inv_total');
            investment.interiorNote = getVal('inv_interiorNote');
            investment.clinicPhotosNote = getVal('clinicPhotosNote');
            investment.govtFeesTotal = getNum('govtFeesTotal');
            investment.runningExpenses = {
                electricity: getNum('running_electricity'),
                advances: getNum('running_advances'),
                equipment: getNum('running_equipment')
            };
            investment.expensesNote = getVal('expensesNote');

            var monthlyData = [];
            document.querySelectorAll('#monthTableBody tr').forEach(function(tr) {
                var month = (tr.querySelector('input.month') && tr.querySelector('input.month').value) || '';
                var rev = parseFloat(tr.querySelector('input.rev') && tr.querySelector('input.rev').value) || 0;
                var exp = parseFloat(tr.querySelector('input.exp') && tr.querySelector('input.exp').value) || 0;
                if (month || rev || exp) monthlyData.push({ month: month, revenue: rev, expenses: exp, netProfitLoss: rev - exp });
            });

            var loanHistory = {
                lenderName: getVal('loan_lender'),
                accountNumber: getVal('loan_account'),
                loanAmountOriginal: getNum('loan_original'),
                processingFeesPaid: getNum('loan_processing'),
                firstEmiDate: getVal('loan_firstEmi'),
                emiAmount: getNum('loan_emi'),
                monthsPaid: getNum('loan_monthsPaid'),
                totalAmountPaid: getNum('loan_totalPaid'),
                outstandingBalance: getNum('loan_outstanding'),
                proposedOtsPct: getNum('loan_otsPct') || 70,
                otsAmount: getNum('loan_otsAmt'),
                savings: getNum('loan_savings')
            };

            var emiTrackerData = [];
            var totEmiPrincipal = 0, totEmiInterest = 0, postClosureInterest = 0;
            document.querySelectorAll('#emiTrackerTableBody tr.emi-tracker-row').forEach(function(tr) {
                var month = (tr.querySelector('.emi-month') && tr.querySelector('.emi-month').value) || '';
                var principal = parseFloat(tr.querySelector('.emi-principal') && tr.querySelector('.emi-principal').value) || 0;
                var interest = parseFloat(tr.querySelector('.emi-interest') && tr.querySelector('.emi-interest').value) || 0;
                var status = (tr.querySelector('.emi-status') && tr.querySelector('.emi-status').value) || '';
                if (month || principal || interest) {
                    emiTrackerData.push({ month: month, principal: principal, interest: interest, totalEmi: principal + interest, status: status });
                    totEmiPrincipal += principal;
                    totEmiInterest += interest;
                    if (status === 'Post-Closure') postClosureInterest += interest;
                }
            });

            var taxCompliance = {
                itReturnsFiled: { fy22: getChecked('tax_fy22'), fy23: getChecked('tax_fy23'), fy24: getChecked('tax_fy24') },
                itReturnsFiles: [getFileName('tax_file22'), getFileName('tax_file23'), getFileName('tax_file24')],
                gstPaid: getNum('tax_gst'),
                professionalTax: getNum('tax_prof'),
                otherGovtFees: getNum('tax_other')
            };

            var legalCosts = {
                courtNoticeFees: getNum('legal_notice'),
                lawyerFees: getNum('legal_lawyer'),
                courtFiles: getFileName('legal_files')
            };

            var healthExpenses = {
                borrowerMedical: getNum('health_borrower'),
                spouseMedical: getNum('health_spouse'),
                healthFiles: getFileName('health_files')
            };

            var evidenceChecklist = {};
            var infrastructure = [];
            var marketing = [];
            ['cat1','cat2','cat3','cat3b','cat4','cat5','cat6','cat8','cat9'].forEach(function(cat) {
                (EVIDENCE_ITEMS[cat] || []).forEach(function(it) {
                    var fid = 'ev_' + it.id;
                    var chk = getChecked('chk_' + fid);
                    var fn = getFileName('file_' + fid);
                    var desc = '';
                    if (it.hasDescription) {
                        var descEl = document.getElementById('desc_' + fid);
                        desc = descEl ? String(descEl.value || '').trim() : '';
                    }
                    var fileList = [];
                    if (it.multiFile) {
                        var fileEl = document.getElementById('file_' + fid);
                        if (fileEl && fileEl.files && fileEl.files.length > 0) {
                            fileList = Array.prototype.map.call(fileEl.files, function(f) { return f.name; });
                        }
                    }
                    evidenceChecklist[it.id] = { checked: chk, fileName: fn || '', description: desc || '', fileList: fileList };
                    if (cat === 'cat2') {
                        infrastructure.push({ id: it.id, label: it.label, checked: chk, fileName: fn || '', description: desc || '', fileList: fileList });
                    }
                    if (cat === 'cat4') {
                        marketing.push({ id: it.id, label: it.label, checked: chk, fileName: fn || '', description: desc || '', fileList: fileList });
                    }
                });
            });

            var debtsRepaid = [];
            document.querySelectorAll('#assetDebtsTableBody tr.asset-debt-row').forEach(function(tr) {
                var lender = (tr.querySelector('.asset-lender') && tr.querySelector('.asset-lender').value) || '';
                var loanAccount = (tr.querySelector('.asset-loanAccount') && tr.querySelector('.asset-loanAccount').value) || '';
                var amountFromSale = parseFloat(tr.querySelector('.asset-amount') && tr.querySelector('.asset-amount').value) || 0;
                var closureStatus = (tr.querySelector('.asset-status') && tr.querySelector('.asset-status').value) || '';
                if (lender || loanAccount || amountFromSale || closureStatus) {
                    debtsRepaid.push({ lender: lender, loanAccount: loanAccount, amountFromSale: amountFromSale, closureStatus: closureStatus });
                }
            });

            var majorAssetSale = {
                propertyDescription: getVal('asset_propertyDesc'),
                propertyAddress: getVal('asset_address'),
                registrationDetails: getVal('asset_registrationDetails'),
                saleValue: getNum('asset_saleValue'),
                saleDate: getVal('asset_saleDate'),
                netAmountReceived: getNum('asset_netReceived'),
                reasonForSale: getVal('asset_reasonForSale'),
                usageNote: getVal('asset_usageNote'),
                debtsRepaid: debtsRepaid,
                totalAppliedToDebt: getNum('asset_totalAppliedToDebt'),
                remarks: getVal('asset_remarks')
            };

            // Collect Monthly Losses data (from Monthly Clinic Loss Calculator)
            var monthlyLosses = [];
            var allMonths = ['Feb24','Mar24','Apr24','May24','Jun24','Jul24','Aug24','Sep24','Oct24','Nov24','Dec24','Jan25','Feb25','Mar25','Apr25','May25','Jun25','Jul25','Aug25','Sep25','Oct25','Nov25','Dec25','Jan26','Feb26'];
            var cumulativeLoss = 0;
            allMonths.forEach(function(month) {
                var rows = document.querySelectorAll('#monthlyLossTableBody tr[data-month="' + month + '"]');
                if (rows.length === 0) {
                    // Check Expense Tracker data (blank template)
                    var etRows = document.querySelectorAll('#expenseTrackerTableBody tr[data-month="' + month + '"]');
                    if (etRows.length > 0) {
                        var monthTotalExpense = 0;
                        etRows.forEach(function(tr) {
                            var expense = parseFloat(tr.querySelector('.et-expense') && tr.querySelector('.et-expense').value) || 0;
                            monthTotalExpense += expense;
                        });
                        var monthNetLoss = monthTotalExpense; // Income always zero
                        cumulativeLoss += monthNetLoss;
                        monthlyLosses.push({
                            month: month,
                            totalExpense: monthTotalExpense,
                            totalIncome: 0,
                            netLoss: monthNetLoss
                        });
                    }
                    return;
                }
                
                var monthTotalIncome = 0, monthTotalExpense = 0;
                rows.forEach(function(tr) {
                    var income = parseFloat(tr.querySelector('.ml-income') && tr.querySelector('.ml-income').value) || 0;
                    var expense = parseFloat(tr.querySelector('.ml-expense') && tr.querySelector('.ml-expense').value) || 0;
                    monthTotalIncome += income;
                    monthTotalExpense += expense;
                });
                var monthNetLoss = monthTotalExpense - monthTotalIncome;
                cumulativeLoss += monthNetLoss;
                monthlyLosses.push({
                    month: month,
                    totalExpense: monthTotalExpense,
                    totalIncome: monthTotalIncome,
                    netLoss: monthNetLoss,
                    notes: month >= 'Nov24' ? 'Closure Phase - No Revenue' : ''
                });
            });

            var monthlyLens = collectMonthlyLensData();
            var monthlyLensNote = getVal('monthlyLensNote');
            var expenses = { onlineInfraTotal: getNum('onlineInfraTotal'), onlineInfraNote: getVal('onlineInfraNote') };

            return {
                exportedAt: new Date().toISOString(),
                lenderName: loanHistory.lenderName,
                accountNumber: loanHistory.accountNumber,
                previousPracticeNote: getVal('previousPracticeNote'),
                hardshipNoPensionNote: getVal('hardshipNoPensionNote'),
                investment: investment,
                expenses: expenses,
                monthlyData: monthlyData,
                monthlyLosses: monthlyLosses,
                cumulativeLoss: cumulativeLoss,
                monthlyLens: monthlyLens,
                monthlyLensNote: monthlyLensNote,
                loanHistory: loanHistory,
                emiTrackerData: emiTrackerData,
                emiTrackerTotals: { totalPrincipal: totEmiPrincipal, totalInterest: totEmiInterest, postClosureInterest: postClosureInterest },
                taxCompliance: taxCompliance,
                legalCosts: legalCosts,
                healthExpenses: healthExpenses,
                majorAssetSale: majorAssetSale,
                evidenceChecklist: evidenceChecklist,
                infrastructure: infrastructure,
                marketing: marketing,
                certificates: window._generatedCertificates || [],
                hardshipFromStep4: window._step4ImportedData || null,
                emailTemplate: window._step4EmailBody || ''
            };
        }

        function importFromStep4() {
            var data = null;
            try {
                var raw = localStorage.getItem('debtEmpireStep4CaseData');
                if (raw) data = JSON.parse(raw);
            } catch (e) {}
            if (!data) {
                document.getElementById('importStatus').textContent = 'No Step 4 data in localStorage. Use Load Step 4 JSON File.';
                return;
            }
            window._step4ImportedData = data;
            window._step4EmailBody = data.emailBody || data.emailDraft || '';
            if (data.loanSnapshot) {
                var snap = data.loanSnapshot;
                var le = document.getElementById('loan_lender'); if (le) le.value = snap.provider || '';
                var ac = document.getElementById('loan_account'); if (ac) ac.value = snap.account || '';
                var os = document.getElementById('loan_outstanding'); if (os) os.value = snap.outstanding || '';
                var pc = document.getElementById('loan_otsPct'); if (pc) pc.value = snap.otsPercent || 70;
                recalcLoan();
            }
            document.getElementById('importStatus').textContent = 'Imported from Step 4. Hardship data merged for export.';
        }

        function loadStep4JsonFile(file) {
            var r = new FileReader();
            r.onload = function() {
                try {
                    var data = JSON.parse(r.result);
                    window._step4ImportedData = data;
                    window._step4EmailBody = data.emailBody || data.emailDraft || '';
                    if (data.loanSnapshot) {
                        var snap = data.loanSnapshot;
                        var le = document.getElementById('loan_lender'); if (le) le.value = snap.provider || '';
                        var ac = document.getElementById('loan_account'); if (ac) ac.value = snap.account || '';
                        var os = document.getElementById('loan_outstanding'); if (os) os.value = snap.outstanding || '';
                        var pc = document.getElementById('loan_otsPct'); if (pc) pc.value = snap.otsPercent || 70;
                        recalcLoan();
                    }
                    document.getElementById('importStatus').textContent = 'Loaded Step 4 JSON.';
                } catch (e) {
                    document.getElementById('importStatus').textContent = 'Error: Invalid JSON.';
                }
            };
            r.readAsText(file);
        }

        function saveTemplate() {
            var data = collectStep5Data();
            data._isTemplate = true;
            var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'step5-template-' + new Date().toISOString().slice(0,10) + '.json';
            document.body.appendChild(a);
            a.click();
            setTimeout(function() { document.body.removeChild(a); URL.revokeObjectURL(a.href); }, 100);
        }

        function loadTemplate(file) {
            var r = new FileReader();
            r.onload = function() {
                try {
                    var data = JSON.parse(r.result);
                    if (data.loanHistory) {
                        var l = data.loanHistory;
                        var set = function(id, v) { var e = document.getElementById(id); if (e) e.value = v; };
                        set('loan_lender', l.lenderName);
                        set('loan_account', l.accountNumber);
                        set('loan_original', l.loanAmountOriginal);
                        set('loan_processing', l.processingFeesPaid);
                        set('loan_firstEmi', l.firstEmiDate);
                        set('loan_emi', l.emiAmount);
                        set('loan_monthsPaid', l.monthsPaid);
                        set('loan_outstanding', l.outstandingBalance);
                        set('loan_otsPct', l.proposedOtsPct || 70);
                    }
                    if (data.previousPracticeNote != null) {
                        var e = document.getElementById('previousPracticeNote');
                        if (e) e.value = data.previousPracticeNote || '';
                    }
                    if (data.hardshipNoPensionNote != null) {
                        var e = document.getElementById('hardshipNoPensionNote');
                        if (e) e.value = data.hardshipNoPensionNote || '';
                    }
                    if (data.investment) {
                        var inv = data.investment;
                        ['registration','rent','equipment','signage','software','medicine'].forEach(function(k) {
                            var e = document.getElementById('inv_' + k);
                            if (e && inv[k] != null) e.value = inv[k];
                        });
                        if (inv.interiorNote != null) {
                            var e = document.getElementById('inv_interiorNote');
                            if (e) e.value = inv.interiorNote || '';
                        }
                        if (inv.clinicPhotosNote != null) {
                            var e = document.getElementById('clinicPhotosNote');
                            if (e) e.value = inv.clinicPhotosNote || '';
                        }
                        if (inv.govtFeesTotal != null) {
                            var e = document.getElementById('govtFeesTotal');
                            if (e) e.value = inv.govtFeesTotal;
                        }
                        if (inv.runningExpenses) {
                            var re = inv.runningExpenses;
                            var reEl = document.getElementById('running_electricity'); if (reEl && re.electricity != null) reEl.value = re.electricity;
                            var raEl = document.getElementById('running_advances'); if (raEl && re.advances != null) raEl.value = re.advances;
                            var rqEl = document.getElementById('running_equipment'); if (rqEl && re.equipment != null) rqEl.value = re.equipment;
                        }
                        if (inv.expensesNote != null) {
                            var e = document.getElementById('expensesNote');
                            if (e) e.value = inv.expensesNote || '';
                        }
                    }
                    if (data.expenses) {
                        var e1 = document.getElementById('onlineInfraTotal'); if (e1) e1.value = data.expenses.onlineInfraTotal != null ? data.expenses.onlineInfraTotal : '';
                        var e2 = document.getElementById('onlineInfraNote'); if (e2) e2.value = data.expenses.onlineInfraNote || '';
                    }
                    if (data.majorAssetSale) {
                        var mas = data.majorAssetSale;
                        var set = function(id, v) { var e = document.getElementById(id); if (e && v != null && v !== '') e.value = v; };
                        set('asset_propertyDesc', mas.propertyDescription);
                        set('asset_address', mas.propertyAddress);
                        set('asset_registrationDetails', mas.registrationDetails);
                        set('asset_saleValue', mas.saleValue);
                        set('asset_saleDate', mas.saleDate);
                        set('asset_netReceived', mas.netAmountReceived);
                        set('asset_reasonForSale', mas.reasonForSale);
                        set('asset_usageNote', mas.usageNote);
                        set('asset_remarks', mas.remarks);
                        var tbody = document.getElementById('assetDebtsTableBody');
                        if (tbody && mas.debtsRepaid && mas.debtsRepaid.length) {
                            tbody.innerHTML = '';
                            mas.debtsRepaid.forEach(function(r) {
                                addAssetDebtRow({ lender: r.lender, loanAccount: r.loanAccount, amountFromSale: r.amountFromSale, closureStatus: r.closureStatus });
                            });
                        }
                        recalcAssetDebtsTotal();
                    }
                    if (data.evidenceChecklist) {
                        Object.keys(data.evidenceChecklist).forEach(function(k) {
                            var v = data.evidenceChecklist[k];
                            var fid = 'ev_' + k;
                            var chkEl = document.getElementById('chk_' + fid);
                            if (chkEl) chkEl.checked = v.checked || false;
                            if (v.description) {
                                var descEl = document.getElementById('desc_' + fid);
                                if (descEl) descEl.value = v.description || '';
                            }
                        });
                    }
                    if (data.monthlyLens && data.monthlyLens.length) {
                        for (var i = 0; i < 12 && i < data.monthlyLens.length; i++) {
                            var m = data.monthlyLens[i];
                            var monthEl = document.getElementById('monthlyLens_' + i + '_month'); if (monthEl) monthEl.value = m.month != null ? m.month : '';
                            var incomeEl = document.getElementById('monthlyLens_' + i + '_income'); if (incomeEl) incomeEl.value = m.income != null ? m.income : '';
                            var emiEl = document.getElementById('monthlyLens_' + i + '_emi'); if (emiEl) emiEl.value = m.emi != null ? m.emi : '';
                            var rentEl = document.getElementById('monthlyLens_' + i + '_rent'); if (rentEl) rentEl.value = m.rent != null ? m.rent : '';
                            var otherEl = document.getElementById('monthlyLens_' + i + '_other'); if (otherEl) otherEl.value = m.other != null ? m.other : '';
                            var netEl = document.getElementById('monthlyLens_' + i + '_net');
                            if (netEl) {
                                var net = (m.income || 0) - ((m.emi || 0) + (m.rent || 0) + (m.other || 0));
                                netEl.textContent = net.toLocaleString('en-IN');
                                netEl.style.color = net < 0 ? '#d32f2f' : '';
                            }
                        }
                    }
                    if (data.monthlyLensNote != null) { var mnEl = document.getElementById('monthlyLensNote'); if (mnEl) mnEl.value = data.monthlyLensNote; }
                    if (data.certificates && data.certificates.length) {
                        window._generatedCertificates = data.certificates;
                        var container = document.getElementById('certificate-forms-container');
                        if (container) {
                            container.innerHTML = '';
                            data.certificates.forEach(function(cert) {
                                var certNo = cert.certNo;
                                container.insertAdjacentHTML('beforeend', createCertificateForm(certNo));
                                var set = function(field, val) {
                                    var el = document.getElementById('cert_' + field + '_' + certNo);
                                    if (el && val) el.value = val;
                                };
                                set('date', cert.eventDate);
                                set('venue', cert.venue);
                                set('datetime', cert.datetime);
                                set('organizer', cert.organizer);
                                set('phone', cert.phone);
                                set('email', cert.email);
                                set('center', cert.center);
                            });
                        }
                    }
                    recalcInvestment();
                    recalcLoan();
                    updateAcUnitsPrintVisibility();
                    updateAwarenessMeetingsPrintVisibility();
                    document.getElementById('importStatus').textContent = 'Template loaded. Update lender/account for new lender.';
                } catch (e) {
                    document.getElementById('importStatus').textContent = 'Error loading template.';
                }
            };
            r.readAsText(file);
        }

        function exportAsJSON() {
            var data = collectStep5Data();
            var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'evidence-package-' + (data.lenderName || 'lender').replace(/\s+/g,'_') + '-' + new Date().toISOString().slice(0,10) + '.json';
            document.body.appendChild(a);
            a.click();
            setTimeout(function() { document.body.removeChild(a); URL.revokeObjectURL(a.href); }, 100);
        }

        function exportAsCSV() {
            var data = collectStep5Data();
            var lines = [];
            lines.push('Section,Field,Value');
            lines.push('Lender,' + (data.lenderName || '').replace(/,/g,';') + ',' + (data.accountNumber || '').replace(/,/g,';'));
            if (data.previousPracticeNote) lines.push('Previous Practice Note,Note,' + (data.previousPracticeNote || '').replace(/,/g,';').replace(/\n/g,' '));
            if (data.hardshipNoPensionNote) lines.push('Hardship No Pension,Note,' + (data.hardshipNoPensionNote || '').replace(/,/g,';').replace(/\n/g,' '));
            lines.push('Investment,Total,' + (data.investment && data.investment.total));
            if (data.investment && data.investment.interiorNote) lines.push('Investment,Interior note,' + (data.investment.interiorNote || '').replace(/,/g,';').replace(/\n/g,' '));
            if (data.investment && data.investment.clinicPhotosNote) lines.push('Evidence,Clinic photos note,' + (data.investment.clinicPhotosNote || '').replace(/,/g,';').replace(/\n/g,' '));
            var cpEv = data.evidenceChecklist && data.evidenceChecklist.clinicPhotos;
            if (cpEv && (cpEv.checked || cpEv.fileName)) lines.push('Evidence,Clinic photos uploaded,' + (cpEv.fileName || '').replace(/,/g,';'));
            if (data.investment && data.investment.govtFeesTotal != null) lines.push('Expenses,Govt Fees,' + data.investment.govtFeesTotal);
            if (data.investment && data.investment.runningExpenses) {
                var re = data.investment.runningExpenses;
                if (re.electricity != null) lines.push('Expenses,Utilities,' + re.electricity);
                if (re.equipment != null) lines.push('Expenses,Equipment Advances,' + re.equipment);
                if (re.advances != null) lines.push('Expenses,Pharma/Marketing,' + re.advances);
            }
            if (data.investment && data.investment.expensesNote) lines.push('Expenses,Cash Receipts note,' + (data.investment.expensesNote || '').replace(/,/g,';').replace(/\n/g,' '));
            if (data.expenses) {
                lines.push('Expenses,Online infra & hosting (Rs),' + (data.expenses.onlineInfraTotal || 0));
                if (data.expenses.onlineInfraNote) lines.push('Expenses,Online infra note,' + (data.expenses.onlineInfraNote || '').replace(/,/g,';').replace(/\n/g,' '));
            }
            if (data.monthlyData) data.monthlyData.forEach(function(m) {
                lines.push('Monthly,' + (m.month||'').replace(/,/g,';') + ',' + m.revenue + ',' + m.expenses + ',' + (m.netProfitLoss||0));
            });
            if (data.loanHistory) {
                var l = data.loanHistory;
                lines.push('Loan,Outstanding,' + l.outstandingBalance);
                lines.push('Loan,OTS Amount,' + l.otsAmount);
            }
            if (data.majorAssetSale) {
                var mas = data.majorAssetSale;
                lines.push('Major Asset Sale,Property description,' + (mas.propertyDescription || '').replace(/,/g,';'));
                lines.push('Major Asset Sale,Location,' + (mas.propertyAddress || '').replace(/,/g,';'));
                lines.push('Major Asset Sale,Registration details,' + (mas.registrationDetails || '').replace(/,/g,';'));
                lines.push('Major Asset Sale,Sale value (Rs),' + (mas.saleValue || ''));
                lines.push('Major Asset Sale,Sale date,' + (mas.saleDate || ''));
                lines.push('Major Asset Sale,Total applied to debt (Rs),' + (mas.totalAppliedToDebt || ''));
                if (mas.debtsRepaid && mas.debtsRepaid.length) {
                    mas.debtsRepaid.forEach(function(r) {
                        lines.push('Major Asset Sale Debt,' + (r.lender||'').replace(/,/g,';') + ',' + (r.loanAccount||'').replace(/,/g,';') + ',' + (r.amountFromSale||'') + ',' + (r.closureStatus||'').replace(/,/g,';'));
                    });
                }
            }
            if (data.evidenceChecklist) {
                Object.keys(data.evidenceChecklist).forEach(function(k) {
                    var v = data.evidenceChecklist[k];
                    var desc = (v.description || '').replace(/,/g,';');
                    var fileList = (v.fileList && v.fileList.length) ? v.fileList.join('; ') : '';
                    lines.push('Evidence,' + k + ',' + (v.checked?'Yes':'No') + ';' + (v.fileName||'').replace(/,/g,';') + (desc ? ';' + desc : '') + (fileList ? ';Files:' + fileList.replace(/,/g,';') : ''));
                });
            }
            if (data.infrastructure && data.infrastructure.length) {
                data.infrastructure.forEach(function(item) {
                    if (item.checked || item.fileName || item.description) {
                        lines.push('Infrastructure,' + item.id + ',' + item.label.replace(/,/g,';') + ',' + (item.checked?'Yes':'No') + ',' + (item.fileName||'').replace(/,/g,';') + ',' + (item.description||'').replace(/,/g,';'));
                    }
                });
            }
            if (data.marketing && data.marketing.length) {
                data.marketing.forEach(function(item) {
                    if (item.checked || item.fileName || item.description || (item.fileList && item.fileList.length)) {
                        var fileList = (item.fileList && item.fileList.length) ? item.fileList.join('; ') : '';
                        lines.push('Marketing,' + item.id + ',' + item.label.replace(/,/g,';') + ',' + (item.checked?'Yes':'No') + ',' + (item.fileName||'').replace(/,/g,';') + ',' + (item.description||'').replace(/,/g,';') + (fileList ? ',' + fileList.replace(/,/g,';') : ''));
                    }
                });
            }
            if (data.certificates && data.certificates.length) {
                data.certificates.forEach(function(cert) {
                    lines.push('Certificate,' + cert.certNoStr + ',' + (cert.venue||'').replace(/,/g,';') + ',' + (cert.organizer||'').replace(/,/g,';') + ',' + (cert.filename||'').replace(/,/g,';') + ',' + (cert.eventDate||'').replace(/,/g,';'));
                });
            }
            if (data.monthlyLosses && data.monthlyLosses.length) {
                lines.push('Monthly Losses,Cumulative Loss (Rs),' + (data.cumulativeLoss || 0));
                data.monthlyLosses.forEach(function(m) {
                    lines.push('Monthly Loss,' + m.month + ',' + m.totalExpense + ',' + m.totalIncome + ',' + m.netLoss + ',' + (m.notes||'').replace(/,/g,';'));
                });
            }
            if (data.monthlyLens && data.monthlyLens.length) {
                lines.push('LoanLens 12-Month Summary,Month,Income,EMI & Loans,Rent,Other,Net');
                data.monthlyLens.forEach(function(m) {
                    lines.push('LoanLens Month,' + (m.month||'').replace(/,/g,';') + ',' + (m.income||0) + ',' + (m.emi||0) + ',' + (m.rent||0) + ',' + (m.other||0) + ',' + (m.net||0));
                });
            }
            if (data.monthlyLensNote) {
                lines.push('LoanLens 12-month hardship note,' + (data.monthlyLensNote || '').replace(/,/g,';').replace(/\n/g,' '));
            }
            if (data.emiTrackerData && data.emiTrackerData.length) {
                lines.push('EMI Tracker,Total Interest Paid (Rs),' + (data.emiTrackerTotals && data.emiTrackerTotals.totalInterest || 0));
                lines.push('EMI Tracker,Post-Closure Interest (Loss) (Rs),' + (data.emiTrackerTotals && data.emiTrackerTotals.postClosureInterest || 0));
                data.emiTrackerData.forEach(function(e) {
                    lines.push('EMI Payment,' + (e.month||'').replace(/,/g,';') + ',' + e.principal + ',' + e.interest + ',' + e.totalEmi + ',' + (e.status||'').replace(/,/g,';'));
                });
            }
            var blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'evidence-package-' + new Date().toISOString().slice(0,10) + '.csv';
            document.body.appendChild(a);
            a.click();
            setTimeout(function() { document.body.removeChild(a); URL.revokeObjectURL(a.href); }, 100);
        }

        function buildPdfHtml(data) {
            var html = '<div style="font-family:Segoe UI,sans-serif;font-size:12px;line-height:1.5;">';
            html += '<h1 style="text-align:center;margin-bottom:20px;">Comprehensive Hardship & Financial Evidence – ' + (data.lenderName || 'Lender') + '</h1>';
            html += '<h2>Executive Summary</h2>';
            var lh = data.loanHistory || {};
html += '<p>Account: ' + (data.accountNumber || '—') + ' | Outstanding: Rs ' + (lh.outstandingBalance || 0).toLocaleString() + ' | OTS Amount: Rs ' + (lh.otsAmount || 0).toLocaleString() + ' | Savings: Rs ' + (lh.savings || 0).toLocaleString() + '</p>';
            html += '<h2>Investment & Setup</h2><p>Total Investment: Rs ' + (data.investment && data.investment.total || 0).toLocaleString();
            if (data.investment && data.investment.interiorNote) html += ' (Interior: ' + (data.investment.interiorNote || '').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,' ') + ')';
            html += '</p>';
            if (data.investment) {
                var inv = data.investment;
                if (inv.govtFeesTotal != null && inv.govtFeesTotal > 0) html += '<p>Govt Fees: Rs ' + (inv.govtFeesTotal || 0).toLocaleString() + '</p>';
                if (inv.runningExpenses) {
                    var re = inv.runningExpenses;
                    var runSum = (re.electricity || 0) + (re.advances || 0) + (re.equipment || 0);
                    if (runSum > 0) html += '<p>Running Expenses: Rs ' + runSum.toLocaleString() + ' (Electricity/Phone/Internet: ' + (re.electricity || 0).toLocaleString() + ', Advances: ' + (re.advances || 0).toLocaleString() + ', Equipment: ' + (re.equipment || 0).toLocaleString() + ')</p>';
                }
                if (inv.expensesNote) html += '<p><strong>Expenses note:</strong> ' + (inv.expensesNote || '').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>') + '</p>';
            }
            if (data.expenses && (data.expenses.onlineInfraTotal > 0 || (data.expenses.onlineInfraNote && data.expenses.onlineInfraNote.trim()))) {
                html += '<p><strong>Online infra &amp; hosting (Vercel/Supabase/Railway):</strong> Rs ' + (data.expenses.onlineInfraTotal || 0).toLocaleString() + '</p>';
                if (data.expenses.onlineInfraNote && data.expenses.onlineInfraNote.trim()) html += '<p><strong>Note:</strong> ' + (data.expenses.onlineInfraNote || '').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>') + '</p>';
            }
            if (data.investment) {
                var inv = data.investment;
                var cpNote = inv.clinicPhotosNote || '';
                var cpEv = data.evidenceChecklist && data.evidenceChecklist.clinicPhotos;
                var cpFile = (cpEv && cpEv.fileName) ? cpEv.fileName : '';
                if (cpNote || cpFile) html += '<p><strong>Clinic Photos:</strong> ' + (cpNote ? cpNote.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,' ') : '') + (cpNote && cpFile ? ', ' : '') + (cpFile ? 'Attached – ' + cpFile.replace(/</g,'&lt;') : '') + '</p>';
            }
            html += '<h2>Monthly Revenue & Losses</h2>';
            html += '<table border="1" cellpadding="4" style="border-collapse:collapse;width:100%;"><tr><th>Month</th><th>Revenue</th><th>Expenses</th><th>Net P/L</th></tr>';
            (data.monthlyData || []).forEach(function(m) {
                html += '<tr><td>' + (m.month||'') + '</td><td>' + m.revenue + '</td><td>' + m.expenses + '</td><td>' + (m.netProfitLoss||0) + '</td></tr>';
            });
            html += '</table>';
            if (data.emiTrackerData && data.emiTrackerData.length) {
                html += '<h2>EMI Payment Tracker (Post-Closure Interest = Loss Evidence)</h2>';
                html += '<p style="color:#d32f2f;font-weight:bold;">Post-Closure Interest Paid (Loss): Rs ' + (data.emiTrackerTotals && data.emiTrackerTotals.postClosureInterest || 0).toLocaleString() + '</p>';
                html += '<table border="1" cellpadding="4" style="border-collapse:collapse;width:100%;margin-top:8px;"><tr><th>Month</th><th>Principal (Rs)</th><th>Interest (Rs)</th><th>Total EMI (Rs)</th><th>Status</th></tr>';
                data.emiTrackerData.forEach(function(e) {
                    var statusColor = (e.status === 'Post-Closure') ? 'color:#d32f2f;font-weight:bold;' : '';
                    html += '<tr><td>' + (e.month||'') + '</td><td>' + e.principal.toLocaleString() + '</td><td style="' + statusColor + '">' + e.interest.toLocaleString() + '</td><td>' + e.totalEmi.toLocaleString() + '</td><td style="' + statusColor + '">' + (e.status||'') + '</td></tr>';
                });
                html += '<tr style="background:#f5f5f5;font-weight:bold;"><td>Total</td><td>' + (data.emiTrackerTotals && data.emiTrackerTotals.totalPrincipal || 0).toLocaleString() + '</td><td style="color:#d32f2f;">' + (data.emiTrackerTotals && data.emiTrackerTotals.totalInterest || 0).toLocaleString() + '</td><td>' + ((data.emiTrackerTotals && data.emiTrackerTotals.totalPrincipal || 0) + (data.emiTrackerTotals && data.emiTrackerTotals.totalInterest || 0)).toLocaleString() + '</td><td></td></tr>';
                html += '</table>';
            }
            if (data.monthlyLosses && data.monthlyLosses.length) {
                html += '<h2>Monthly Clinic Expenses (Rent Excluded)</h2>';
                html += '<p style="color:#666;font-size:12px;">Track Feb 2024-Oct 2024 (running losses) + Nov 2024-Feb 2026 (closure losses). EXCLUDE RENT. Shows ₹ outflow from Dr. Nehru\'s pocket monthly.</p>';
                html += '<table border="1" cellpadding="6" style="border-collapse:collapse;width:100%;margin-top:12px;font-size:11px;"><tr style="background:#f5f5f5;"><th>Month</th><th>Total Expense</th><th>Income</th><th>Net Loss</th><th>Cumulative Loss</th></tr>';
                var cumLoss = 0;
                data.monthlyLosses.forEach(function(m) {
                    cumLoss += m.netLoss;
                    html += '<tr><td>' + m.month + (m.notes ? ' <span style="color:#d32f2f;font-size:10px;">(Closure)</span>' : '') + '</td>' +
                        '<td>₹' + m.totalExpense.toLocaleString('en-IN') + '</td>' +
                        '<td>₹' + m.totalIncome.toLocaleString('en-IN') + '</td>' +
                        '<td style="color:#d32f2f;">₹' + m.netLoss.toLocaleString('en-IN') + '</td>' +
                        '<td style="color:#d32f2f;font-weight:bold;">₹' + cumLoss.toLocaleString('en-IN') + '</td></tr>';
                });
                html += '</table>';
                html += '<p style="margin-top:12px;font-weight:bold;color:#d32f2f;">Cumulative Loss (Feb24-Feb26): ₹' + (data.cumulativeLoss || 0).toLocaleString('en-IN') + '</p>';
            }
            if (data.monthlyLens && data.monthlyLens.length) {
                html += '<h2>LoanLens 12-Month Cashflow Summary</h2>';
                html += '<table border="1" cellpadding="4" style="border-collapse:collapse;width:100%;font-size:11px;margin-top:8px;"><tr style="background:#f5f5f5;"><th>Month/Year</th><th>Income (Rs)</th><th>EMI &amp; Loans (Rs)</th><th>Rent (Rs)</th><th>Other (Rs)</th><th>Net (Rs)</th></tr>';
                data.monthlyLens.forEach(function(m) {
                    html += '<tr><td>' + (m.month||'').replace(/</g,'&lt;') + '</td><td>' + (m.income||0).toLocaleString('en-IN') + '</td><td>' + (m.emi||0).toLocaleString('en-IN') + '</td><td>' + (m.rent||0).toLocaleString('en-IN') + '</td><td>' + (m.other||0).toLocaleString('en-IN') + '</td><td style="' + (m.net < 0 ? 'color:#d32f2f;' : '') + '">' + (m.net||0).toLocaleString('en-IN') + '</td></tr>';
                });
                html += '</table>';
                if (data.monthlyLensNote && data.monthlyLensNote.trim()) {
                    html += '<p style="margin-top:10px;"><strong>12-month hardship note:</strong> ' + (data.monthlyLensNote || '').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>') + '</p>';
                }
            }
            html += '<h2>Evidence Checklist</h2><ul>';
            if (data.evidenceChecklist) {
                Object.keys(data.evidenceChecklist).forEach(function(k) {
                    var v = data.evidenceChecklist[k];
                    if (k === 'loanLensPack') {
                        html += '<li>LoanLens monthly cashflow PDFs: ' + (v.checked || v.fileName ? 'Attached' : 'Not attached') + ' – ' + (v.fileName || '').replace(/</g,'&lt;') + '</li>';
                        return;
                    }
                    if (k === 'onlineInfraReceipts') {
                        var fileNames = (v.fileName || (v.fileList && v.fileList.length ? v.fileList.join(', ') : '')).replace(/</g,'&lt;');
                        html += '<li>Online infra receipts: ' + (v.checked || v.fileName || (v.fileList && v.fileList.length) ? 'Attached' : 'Not attached') + ' – ' + fileNames + '</li>';
                        return;
                    }
                    if (v.checked) {
                        var label = (k === 'interior_quote') ? 'Interior quotation/bill' : (k === 'clinicPhotos') ? 'Real clinic photos' : k;
                        var desc = (v.description && v.description.trim()) ? ' – ' + v.description.replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';
                        html += '<li>' + label + ' – Attached: ' + (v.fileName || '(file)') + desc + '</li>';
                    }
                });
            }
            html += '</ul>';
            if (data.infrastructure && data.infrastructure.length) {
                var hasInfra = false;
                var infraHtml = '<h2>Infrastructure / Clinic Setup</h2><ul>';
                data.infrastructure.forEach(function(item) {
                    if (item.id === 'ac_units' && !item.checked && !item.fileName && !item.description) {
                        return;
                    }
                    if (item.checked || item.fileName || item.description) {
                        hasInfra = true;
                        var desc = item.description ? ' – ' + item.description.replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';
                        infraHtml += '<li>' + item.label + (item.checked ? ' (Checked)' : '') + (item.fileName ? ' – File: ' + item.fileName.replace(/</g,'&lt;') : '') + desc + '</li>';
                    }
                });
                infraHtml += '</ul>';
                if (hasInfra) html += infraHtml;
            }
            if (data.marketing && data.marketing.length) {
                var hasMarketing = false;
                var marketingHtml = '<h2>Marketing & Promotion</h2><ul>';
                data.marketing.forEach(function(item) {
                    if (item.id === 'awareness_meetings' && !item.checked && !item.fileName && !item.description && (!item.fileList || item.fileList.length === 0)) {
                        return;
                    }
                    if (item.checked || item.fileName || item.description || (item.fileList && item.fileList.length > 0)) {
                        hasMarketing = true;
                        var desc = item.description ? ' – ' + item.description.replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';
                        var fileList = (item.fileList && item.fileList.length) ? ' – Files: ' + item.fileList.map(function(f) { return f.replace(/</g,'&lt;'); }).join(', ') : '';
                        marketingHtml += '<li>' + item.label + (item.checked ? ' (Checked)' : '') + (item.fileName ? ' – File: ' + item.fileName.replace(/</g,'&lt;') : '') + fileList + desc + '</li>';
                    }
                });
                marketingHtml += '</ul>';
                if (hasMarketing) html += marketingHtml;
            }
            if (data.certificates && data.certificates.length) {
                html += '<h2>Professional Endorsement Certificates</h2><ul>';
                data.certificates.forEach(function(cert) {
                    html += '<li>Certificate ' + cert.certNoStr + ' – Venue: ' + (cert.venue || '').replace(/</g,'&lt;') + ', Organizer: ' + (cert.organizer || '').replace(/</g,'&lt;') + ', File: ' + (cert.filename || '').replace(/</g,'&lt;') + '</li>';
                });
                html += '</ul>';
            }
            if (data.previousPracticeNote) {
                html += '<h3>Note about earlier hospital closed for this clinic</h3><p>' + (data.previousPracticeNote || '').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>') + '</p>';
            }
            if (data.hardshipNoPensionNote) {
                html += '<h3>Hardship – No Govt Job or Pension</h3><p>' + (data.hardshipNoPensionNote || '').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>') + '</p>';
            }
            if (data.majorAssetSale && (data.majorAssetSale.propertyDescription || data.majorAssetSale.saleValue || (data.majorAssetSale.debtsRepaid && data.majorAssetSale.debtsRepaid.length))) {
                var mas = data.majorAssetSale;
                html += '<h2>Major Asset Sold to Repay Debts</h2>';
                html += '<p>' + (mas.propertyDescription || '').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '. ' + (mas.propertyAddress || '').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</p>';
                if (mas.registrationDetails) html += '<p>Registration: ' + (mas.registrationDetails || '').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</p>';
                html += '<p>Sale value: Rs ' + (mas.saleValue || 0).toLocaleString() + ' | Sale date: ' + (mas.saleDate || '—') + '</p>';
                if (mas.reasonForSale) html += '<p><strong>Reason for sale:</strong> ' + (mas.reasonForSale || '').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</p>';
                if (mas.usageNote) html += '<p><strong>Usage of proceeds:</strong> ' + (mas.usageNote || '').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</p>';
                if (mas.debtsRepaid && mas.debtsRepaid.length) {
                    html += '<table border="1" cellpadding="4" style="border-collapse:collapse;width:100%;margin-top:8px;"><tr><th>Lender</th><th>Account</th><th>Amount (Rs)</th><th>Status</th></tr>';
                    mas.debtsRepaid.forEach(function(r) {
                        html += '<tr><td>' + (r.lender||'').replace(/</g,'&lt;') + '</td><td>' + (r.loanAccount||'').replace(/</g,'&lt;') + '</td><td>' + (r.amountFromSale||0).toLocaleString() + '</td><td>' + (r.closureStatus||'').replace(/</g,'&lt;') + '</td></tr>';
                    });
                    html += '</table>';
                }
            }
            if (data.hardshipFromStep4 && data.emailTemplate) {
                html += '<h2>Hardship Narrative (from Step 4)</h2><pre style="white-space:pre-wrap;background:#f5f5f5;padding:12px;">' + (data.emailTemplate || '').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</pre>';
            }
            html += '</div>';
            return html;
        }

        function exportAsPDF() {
            if (typeof html2pdf === 'undefined') { alert('PDF library loading... Try again.'); return; }
            var data = collectStep5Data();
            var content = document.getElementById('pdfContent');
            content.innerHTML = buildPdfHtml(data);
            var opt = { margin: 10, filename: 'evidence-package-' + (data.lenderName||'lender').replace(/\s+/g,'_') + '-' + new Date().toISOString().slice(0,10) + '.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, letterRendering: true, logging: false }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            var doCapture = function() {
                html2pdf().set(opt).from(content).save().then(function() {
                    content.innerHTML = '';
                }).catch(function(err) {
                    content.innerHTML = '';
                    alert('PDF export failed. Try Save as JSON or CSV instead. ' + (err && err.message ? err.message : ''));
                });
            };
            requestAnimationFrame(function() {
                requestAnimationFrame(function() {
                    setTimeout(doCapture, 150);
                });
            });
        }

        function init() {
            ['inv_registration','inv_rent','inv_equipment','inv_signage','inv_software','inv_medicine'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el) el.addEventListener('input', recalcInvestment);
            });
            ['loan_emi','loan_monthsPaid','loan_outstanding','loan_otsPct'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el) el.addEventListener('input', recalcLoan);
            });
            renderEvidenceCategory('cat1', 'ev_cat1');
            renderEvidenceCategory('cat2', 'ev_cat2');
            renderEvidenceCategory('cat3', 'ev_cat3');
            renderEvidenceCategory('cat3b', 'ev_cat3b');
            renderEvidenceCategory('cat4', 'ev_cat4');
            renderEvidenceCategory('cat5', 'ev_cat5');
            renderEvidenceCategory('cat6', 'ev_cat6');
            renderEvidenceCategory('cat8', 'ev_cat8');
            renderEvidenceCategory('cat9', 'ev_cat9');
            renderHardshipTemplates();
            document.getElementById('btnCopyHardshipTemplate').addEventListener('click', function() {
                var ta = document.getElementById('hardshipTemplateDisplay');
                if (ta && navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(ta.value).then(function() { alert('Copied to clipboard.'); }).catch(function() {});
                }
            });
            initMonthlyLensTable();
            document.getElementById('btnAddMonth').addEventListener('click', addMonthRow);
            addMonthRow();
            document.getElementById('btnAddEmiRow').addEventListener('click', addEmiRow);
            addEmiRow();
            document.getElementById('btnAddAssetDebt').addEventListener('click', function() { addAssetDebtRow(); });
            addAssetDebtRow();
            document.getElementById('btnAddMonthlyLossRow').addEventListener('click', addMonthlyLossRow);
            document.getElementById('btnCalculateMonthlyLoss').addEventListener('click', calculateMonthlyLoss);
            document.getElementById('btnExportMonthlyLosses').addEventListener('click', exportMonthlyLosses);
            document.getElementById('monthlyLoss_month').addEventListener('change', function() {
                var month = this.value;
                if (month) {
                    var rows = document.querySelectorAll('#monthlyLossTableBody tr[data-month="' + month + '"]');
                    if (rows.length > 0) {
                        document.getElementById('monthlyLossTable').style.display = 'table';
                        recalcMonthlyLossTotals(month);
                        updateMonthlyLossSummary();
                    }
                }
            });
            document.getElementById('btnCalculateExpenseTracker').addEventListener('click', calculateExpenseTracker);
            document.getElementById('btnExportExpenseTracker').addEventListener('click', exportExpenseTracker);
            document.getElementById('expenseTracker_month').addEventListener('change', function() {
                var month = this.value;
                if (month) {
                    initExpenseTrackerTable(month);
                }
            });
            // Pre-populate sample data for Feb24 (optional - user can clear if needed)
            setTimeout(function() {
                var monthSelect = document.getElementById('monthlyLoss_month');
                if (monthSelect && monthSelect.value === '') {
                    monthSelect.value = 'Feb24';
                    var sampleData = [
                        { date: '2024-02-05', category: 'Staff Salary', description: 'Nurse Salary', expense: 15000 },
                        { date: '2024-02-10', category: 'Travel (Rajahmundry/Adoni/Khammam meetings)', description: 'Rajahmundry Meeting', expense: 5000 },
                        { date: '2024-02-15', category: 'Phone/Telephone Bills', description: 'Jio Postpaid', expense: 1200 },
                        { date: '2024-02-20', category: 'Online Ads (Google Ads bills)', description: 'Google Ads Practo', expense: 3000 },
                        { date: '2024-02-25', category: 'Fuel/Transport', description: 'Adoni Camp Travel', expense: 2500 }
                    ];
                    sampleData.forEach(function(item) {
                        addMonthlyLossRow();
                        var rows = document.querySelectorAll('#monthlyLossTableBody tr[data-month="Feb24"]');
                        if (rows.length > 0) {
                            var lastRow = rows[rows.length - 1];
                            var dateInput = lastRow.querySelector('.ml-date');
                            var categorySelect = lastRow.querySelector('.ml-category');
                            var descInput = lastRow.querySelector('.ml-description');
                            var expenseInput = lastRow.querySelector('.ml-expense');
                            if (dateInput) dateInput.value = item.date;
                            if (categorySelect) {
                                categorySelect.value = item.category;
                                if (categorySelect.value === '__CUSTOM__') {
                                    var customInput = lastRow.querySelector('.ml-category-custom');
                                    if (customInput) {
                                        customInput.style.display = 'block';
                                        customInput.value = item.category;
                                    }
                                }
                            }
                            if (descInput) descInput.value = item.description;
                            if (expenseInput) expenseInput.value = item.expense;
                            recalcMonthlyLossRow(lastRow);
                        }
                    });
                    recalcMonthlyLossTotals('Feb24');
                    updateMonthlyLossSummary();
                    document.getElementById('monthlyLossTable').style.display = 'table';
                }
            }, 500);
            document.getElementById('btnImportStep4').addEventListener('click', importFromStep4);
            document.getElementById('btnLoadStep4Json').addEventListener('click', function() { document.getElementById('loadStep4File').click(); });
            document.getElementById('loadStep4File').addEventListener('change', function() { var f = this.files[0]; if (f) loadStep4JsonFile(f); this.value = ''; });
            document.getElementById('btnSaveTemplate').addEventListener('click', saveTemplate);
            document.getElementById('btnLoadTemplate').addEventListener('click', function() { document.getElementById('loadTemplateFile').click(); });
            document.getElementById('loadTemplateFile').addEventListener('change', function() { var f = this.files[0]; if (f) loadTemplate(f); this.value = ''; });
            document.getElementById('btnGenerate').addEventListener('click', function() {
                try {
                    collectStep5Data();
                    var msg = 'Data collected. Use Save as JSON / CSV / PDF below.';
                    document.getElementById('importStatus').textContent = msg;
                    var gs = document.getElementById('generateStatus');
                    if (gs) { gs.textContent = msg; gs.style.color = '#2e7d32'; }
                } catch (e) {
                    var err = 'Error: ' + (e && e.message ? e.message : 'Could not collect data');
                    document.getElementById('importStatus').textContent = err;
                    var gs = document.getElementById('generateStatus');
                    if (gs) { gs.textContent = err; gs.style.color = '#c62828'; }
                }
            });
            document.getElementById('btnExportJSON').addEventListener('click', exportAsJSON);
            document.getElementById('btnExportCSV').addEventListener('click', exportAsCSV);
            document.getElementById('btnExportPDF').addEventListener('click', exportAsPDF);
            document.getElementById('btnAddCertificate').addEventListener('click', addCertificateForm);
            addCertificateForm();
            recalcInvestment();
            recalcLoan();
        }
        init();
    })();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</body>
</html>
