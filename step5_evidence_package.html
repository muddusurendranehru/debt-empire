<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debt Empire — Step 5: Comprehensive Evidence Package</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; color: #333; line-height: 1.5; }
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 { font-size: 22px; margin-bottom: 6px; }
        .header .subtitle { font-size: 13px; opacity: 0.9; }
        .layout {
            display: flex;
            min-height: calc(100vh - 120px);
            gap: 0;
        }
        .left-panel {
            width: 50%;
            background: white;
            border-right: 2px solid #e0e0e0;
            padding: 16px;
            overflow-y: auto;
        }
        .right-panel {
            width: 50%;
            background: #fafafa;
            padding: 16px;
            overflow-y: auto;
        }
        .section-title {
            font-size: 14px;
            font-weight: 700;
            margin: 16px 0 8px 0;
            color: #1a237e;
            border-bottom: 2px solid #3949ab;
            padding-bottom: 4px;
        }
        .section-title.money::before { content: "Rs "; }
        .input-row { margin: 6px 0; }
        .input-row label { display: block; font-size: 12px; font-weight: 500; margin-bottom: 2px; }
        .input-row input, .input-row select, .input-row textarea { width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
        .input-row textarea { min-height: 50px; resize: vertical; }
        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: #3949ab;
            color: white;
        }
        .btn:hover { opacity: 0.9; }
        .btn-success { background: #2e7d32; }
        .btn-primary { background: #1565c0; padding: 10px 18px; font-size: 14px; }
        .ev-item { margin: 8px 0; padding: 8px; background: white; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 12px; }
        .ev-item .cb-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .ev-item .cb-row input[type="checkbox"] { width: auto; }
        .ev-item .file-row { margin-top: 4px; font-size: 11px; color: #666; }
        .month-table { width: 100%; font-size: 11px; border-collapse: collapse; }
        .month-table th, .month-table td { padding: 4px 6px; border: 1px solid #e0e0e0; }
        .month-table th { background: #e8eaf6; }
        .action-bar { margin: 20px 0; padding: 16px; background: #e3f2fd; border-radius: 6px; text-align: center; }
        .action-bar .btn { margin: 0 6px; }
        .note-small { font-size: 11px; color: #666; margin-top: 6px; font-style: italic; }
        .hardship-suggested-box { margin-top: 12px; padding: 12px; background: #e3f2fd; border-radius: 6px; border: 1px solid #bbdefb; }
        .hardship-template-label { display: block; margin: 4px 0; padding: 4px 8px; font-size: 11px; color: #1565c0; cursor: pointer; border-radius: 4px; }
        .hardship-template-label:hover { background: #bbdefb; }
        @media (max-width: 900px) { .layout { flex-direction: column; } .left-panel, .right-panel { width: 100%; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>Debt Empire — Step 5: Comprehensive Evidence Package</h1>
        <div class="subtitle">Final OTS Submission Builder — Financial journey, loss summary, and evidence checklist per lender</div>
    </div>

    <div class="action-bar">
        <button type="button" class="btn" id="btnImportStep4">Import Hardship Data from Step 4</button>
        <input type="file" id="loadStep4File" accept=".json" style="display:none">
        <button type="button" class="btn" id="btnLoadStep4Json">Load Step 4 JSON File</button>
        <button type="button" class="btn btn-success" id="btnSaveTemplate">Save as Template</button>
        <button type="button" class="btn" id="btnLoadTemplate">Load Template</button>
        <input type="file" id="loadTemplateFile" accept=".json" style="display:none">
        <span id="importStatus" style="margin-left:10px;font-size:12px;"></span>
    </div>

    <div class="layout">
        <div class="left-panel">
            <div class="section-title">1. Rs Investment & Setup (One-time costs)</div>
            <div class="input-row"><label>Clinic registration & licences (Rs):</label><input type="number" id="inv_registration" min="0" placeholder="0"></div>
            <div class="input-row"><label>Rent deposit & advance (Rs):</label><input type="number" id="inv_rent" min="0" placeholder="0"></div>
            <div class="input-row"><label>Equipment & furniture (Rs):</label><input type="number" id="inv_equipment" min="0" placeholder="0"></div>
            <div class="input-row"><label>Interior & boards/signage (Rs):</label><input type="number" id="inv_signage" min="0" placeholder="0"></div>
            <div class="input-row"><label>Short note on interior work (HOMA Clinic):</label><textarea id="inv_interiorNote" rows="2" placeholder="Complete turnkey interior for HOMA Clinic (ceilings, partitions, pharmacy and lab furniture, reception, electrical and painting) as per attached quotation (approx. Rs. 17.2 lakh)."></textarea></div>
            <div class="input-row"><label>Hospital software & IT (Rs):</label><input type="number" id="inv_software" min="0" placeholder="0"></div>
            <div class="input-row"><label>Initial medicine stock (Rs):</label><input type="number" id="inv_medicine" min="0" placeholder="0"></div>
            <div class="input-row"><label><strong>Total Investment (Rs):</strong></label><input type="number" id="inv_total" readonly placeholder="Auto-calculated"></div>
            <div class="input-row"><label>Govt Fees &amp; Compliance (Rs):</label><input type="number" id="govtFeesTotal" min="0" placeholder="0"></div>

            <div class="section-title">Running Expenses (Rs totals)</div>
            <div class="input-row"><label>Electricity/Phone/Internet:</label><input type="number" id="running_electricity" min="0" placeholder="0"></div>
            <div class="input-row"><label>Advances (equipment/pharma/marketing):</label><input type="number" id="running_advances" min="0" placeholder="0"></div>
            <div class="input-row"><label>Furniture/Equipment (fans, AC, chairs, stools):</label><input type="number" id="running_equipment" min="0" placeholder="0"></div>
            <div class="input-row"><label>Note on expenses (receipts attached):</label><textarea id="expensesNote" rows="2" placeholder="Online receipts, cash bills, pharma dues, equipment advances, etc."></textarea></div>

            <div class="section-title">2. Monthly Revenue & Losses</div>
            <div class="input-row"><button type="button" class="btn" id="btnAddMonth">Add Month</button></div>
            <table class="month-table" id="monthTable">
                <thead><tr><th>Month/Year</th><th>Revenue (Rs)</th><th>Expenses (Rs)</th><th>Net P/L</th><th></th></tr></thead>
                <tbody id="monthTableBody"></tbody>
                <tfoot><tr><td><strong>Total</strong></td><td id="totRevenue">0</td><td id="totExpenses">0</td><td id="totNet">0</td><td></td></tr></tfoot>
            </table>

            <div class="section-title">3. Loan Payment History (Current Lender)</div>
            <div class="input-row"><label>Lender Name:</label><input type="text" id="loan_lender" placeholder="e.g. HDFC, Bajaj Finance"></div>
            <div class="input-row"><label>Account Number:</label><input type="text" id="loan_account" placeholder="Account ref"></div>
            <div class="input-row"><label>Loan Amount Original (Rs):</label><input type="number" id="loan_original" min="0" placeholder="0"></div>
            <div class="input-row"><label>Processing Fees Paid (Rs):</label><input type="number" id="loan_processing" min="0" placeholder="0"></div>
            <div class="input-row"><label>First EMI Date:</label><input type="text" id="loan_firstEmi" placeholder="e.g. 2020-04"></div>
            <div class="input-row"><label>EMI Amount (Rs):</label><input type="number" id="loan_emi" min="0" placeholder="0"></div>
            <div class="input-row"><label>Months Paid:</label><input type="number" id="loan_monthsPaid" min="0" placeholder="0"></div>
            <div class="input-row"><label>Total Amount Paid (Rs):</label><input type="number" id="loan_totalPaid" readonly placeholder="Auto"></div>
            <div class="input-row"><label>Outstanding Balance (Rs):</label><input type="number" id="loan_outstanding" min="0" placeholder="0"></div>
            <div class="input-row"><label>Proposed OTS %:</label><input type="number" id="loan_otsPct" min="1" max="100" placeholder="70"></div>
            <div class="input-row"><label>OTS Amount (Rs):</label><input type="number" id="loan_otsAmt" readonly placeholder="Auto"></div>
            <div class="input-row"><label>Savings (Rs):</label><input type="number" id="loan_savings" readonly placeholder="Auto"></div>

            <div class="section-title">4. Tax & Compliance Costs</div>
            <div class="input-row"><label>IT Returns (FY22-23):</label><input type="checkbox" id="tax_fy22"> Filed <input type="file" id="tax_file22" accept=".pdf,.jpg,.png" style="font-size:11px"></div>
            <div class="input-row"><label>IT Returns (FY23-24):</label><input type="checkbox" id="tax_fy23"> Filed <input type="file" id="tax_file23" accept=".pdf,.jpg,.png" style="font-size:11px"></div>
            <div class="input-row"><label>IT Returns (FY24-25):</label><input type="checkbox" id="tax_fy24"> Filed <input type="file" id="tax_file24" accept=".pdf,.jpg,.png" style="font-size:11px"></div>
            <div class="input-row"><label>GST paid despite zero revenue (Rs):</label><input type="number" id="tax_gst" min="0" placeholder="0"></div>
            <div class="input-row"><label>Professional tax (Rs):</label><input type="number" id="tax_prof" min="0" placeholder="0"></div>
            <div class="input-row"><label>Other govt fees (Rs):</label><input type="number" id="tax_other" min="0" placeholder="0"></div>

            <div class="section-title">5. Legal & Court Costs</div>
            <div class="input-row"><label>Court notice fees (Rs):</label><input type="number" id="legal_notice" min="0" placeholder="0"></div>
            <div class="input-row"><label>Lawyer consultation fees (Rs):</label><input type="number" id="legal_lawyer" min="0" placeholder="0"></div>
            <div class="input-row"><label>Court notices/summons:</label><input type="file" id="legal_files" multiple accept=".pdf,.jpg,.png" style="font-size:11px"></div>

            <div class="section-title">6. Family Health Expenses</div>
            <div class="input-row"><label>Borrower medical costs (Rs):</label><input type="number" id="health_borrower" min="0" placeholder="0"></div>
            <div class="input-row"><label>Spouse medical costs (Rs):</label><input type="number" id="health_spouse" min="0" placeholder="0"></div>
            <div class="input-row"><label>Health certificates/bills:</label><input type="file" id="health_files" multiple accept=".pdf,.jpg,.png" style="font-size:11px"></div>

            <!-- Section 7: Major Asset Sale - Add new sections by inserting before this block with same .section-title + .input-row pattern -->
            <div class="section-title">7. Major Asset Sold to Repay Debts (Optional)</div>
            <p class="note-small">Use this section when you have sold a house, land, or other big asset and used the money mainly to repay loans related to the clinic.</p>
            <div class="input-row"><label>Property description:</label><input type="text" id="asset_propertyDesc" placeholder="House No. 2/8, Bahar-B, Sahara States, Mansoorabad"></div>
            <div class="input-row"><label>Location / address:</label><input type="text" id="asset_address" placeholder="Mansoorabad, Saroornagar, Ranga Reddy, Telangana"></div>
            <div class="input-row"><label>Document / registration details:</label><input type="text" id="asset_registrationDetails" placeholder="Sale Deed Doc No. 4654/2025, SRO Saroornagar, dated 16-07-2025"></div>
            <div class="input-row"><label>Sale value (Rs):</label><input type="number" id="asset_saleValue" min="0" placeholder="4980000"></div>
            <div class="input-row"><label>Date of sale / registration:</label><input type="date" id="asset_saleDate"></div>
            <div class="input-row"><label>Net amount actually received (Rs, after deductions):</label><input type="number" id="asset_netReceived" min="0" placeholder="Optional"></div>
            <div class="input-row"><label>Main reason for sale:</label><textarea id="asset_reasonForSale" rows="3" placeholder="Forced sale due to continuous clinic losses and inability to pay EMIs."></textarea></div>
            <div class="input-row"><label>Short note on how sale proceeds were used:</label><textarea id="asset_usageNote" rows="4" placeholder="Proceeds used mainly to close one Bajaj loan and part-pay another clinic loan; not used for lifestyle."></textarea></div>
            <div class="input-row"><button type="button" class="btn" id="btnAddAssetDebt">Add Loan Row</button></div>
            <table class="month-table" id="assetDebtsTable">
                <thead><tr><th>Lender / creditor</th><th>Loan type / account no.</th><th>Amount paid from sale (Rs)</th><th>Closure status</th><th></th></tr></thead>
                <tbody id="assetDebtsTableBody"></tbody>
                <tfoot><tr><td colspan="2"><strong>Total amount applied to debt (Rs)</strong></td><td colspan="2"><input type="number" id="asset_totalAppliedToDebt" readonly placeholder="0" style="width:100%;"></td><td></td></tr></tfoot>
            </table>
            <div class="input-row"><label>Any other remarks (optional):</label><textarea id="asset_remarks" rows="2" placeholder="Optional"></textarea></div>

            <div class="section-title">8. Old previous hospital management (without failure)</div>
            <p class="note-small">Evidence of losing clientele and regular income; ran a registered hospital for years before closing to start this clinic.</p>
            <div class="input-row"><label>Note about earlier hospital closed for this clinic:</label><textarea id="previousPracticeNote" rows="3" placeholder="Previously ran Surendra Nehru Hospital, a registered private hospital in Godavarikhani (DMHO certificate attached), which I closed to invest in HOMA Clinic."></textarea></div>

            <div class="section-title">9. Hardship – No Govt Job or Pension</div>
            <p class="note-small">Loss of government job, no pension. Past government and teaching service; income depended only on private practice, which is now closed.</p>
            <div class="input-row"><label>Narrative about loss of government job and no pension:</label><textarea id="hardshipNoPensionNote" rows="4" placeholder="Example: I previously served in government and teaching posts (Civil Assistant Surgeon / Assistant Professor), but I am no longer in government service and do not receive any government salary or pension. My income depended only on private practice, which is now closed."></textarea><p class="note-small">You may choose and adapt any of the templates from the right-hand box for your hardship narrative.</p></div>
        </div>

        <div class="right-panel">
            <div class="section-title">Business Setup & Closure Evidence Checklist</div>
            <p class="note-small">Check items and select files. Files are listed in export; attach manually when emailing.</p>

            <div class="section-title">Category 1: Business Registration & Licences</div>
            <div id="ev_cat1"></div>

            <div class="section-title">Category 2: Clinic Infrastructure</div>
            <div id="ev_cat2"></div>

            <div class="section-title">Category 3: Government Permissions & Taxes</div>
            <div id="ev_cat3"></div>

            <div class="section-title">Running Expenses & Equipment</div>
            <div id="ev_cat3b"></div>

            <div class="section-title">Category 4: Marketing & Digital Presence</div>
            <div id="ev_cat4"></div>

            <div class="section-title">Category 5: Closure Documents</div>
            <div id="ev_cat5"></div>

            <div class="section-title">Category 6: Hardship Documents</div>
            <div id="ev_cat6"></div>

            <div class="section-title">Category 8: Old previous hospital management (without failure)</div>
            <div id="ev_cat8"></div>

            <div class="section-title">Category 9: Hardship – Loss of Government Job and No Pension</div>
            <div id="ev_cat9"></div>

            <div class="hardship-suggested-box">
                <div class="section-title" style="font-size:12px;">Suggested hardship wording (for OTS emails and notes)</div>
                <div id="hardshipTemplatesList" style="margin-top:8px;"></div>
                <textarea id="hardshipTemplateDisplay" readonly rows="6" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:12px;margin-top:8px;background:#fff;resize:vertical;"></textarea>
                <button type="button" class="btn" id="btnCopyHardshipTemplate" style="margin-top:8px;">Copy text</button>
            </div>

            <div class="action-bar" style="margin-top:24px;">
                <button type="button" class="btn btn-primary" id="btnGenerate">Generate Comprehensive Evidence Package</button>
                <span id="generateStatus" style="margin-left:12px;font-size:13px;color:#2e7d32;font-weight:500;"></span>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;justify-content:center;">
                <button type="button" class="btn btn-success" id="btnExportJSON">Save as JSON</button>
                <button type="button" class="btn" id="btnExportCSV">Save as CSV</button>
                <button type="button" class="btn" id="btnExportPDF">Save as PDF</button>
            </div>
        </div>
    </div>

    <div id="pdfContent" style="position:absolute;left:-9999px;top:0;width:800px;min-height:400px;padding:20px;background:#fff;font-family:Segoe UI,sans-serif;"></div>

    <script>
    (function() {
        'use strict';
        var HARDSHIP_TEMPLATES = [
            { id: 'no_govt_pension', label: 'Loss of government job and no pension', text: 'Earlier in my career I served in government and teaching posts as a doctor, but I am no longer in government service and do not receive any government salary or pension. My income in recent years depended entirely on my private hospital and clinic practice, which has had to close, causing a severe and continuing reduction in my earnings. Despite selling assets and cutting personal expenses to repay as much as possible, I am currently unable to maintain the original instalment schedule on these loans. I am therefore requesting a reasonable one-time settlement or restructured arrangement so that I can close these obligations in a fair and sustainable manner.' },
            { id: 'closure_hospital_clinic', label: 'Closure of earlier hospital and current clinic', text: 'I previously managed a fully functional, registered hospital/clinic, which was closed in order to invest in and establish my current clinic. That investment has not produced the expected income, and the clinic has faced sustained operating losses, leading to serious cash-flow constraints. I have used the proceeds from closing the earlier hospital and subsequent income to service my debts to the maximum extent possible. I now seek a fair settlement or restructuring so that these loans can be closed in an orderly and transparent manner.' },
            { id: 'major_asset_sold', label: 'Major asset sold to repay debts', text: 'To honour my obligations in good faith, I have already sold a major personal/family asset and applied the sale proceeds towards repayment of multiple loans, as reflected in the enclosed sale deed and bank statements. After this one-time sacrifice, I no longer have comparable assets available to liquidate. Even after applying the entire sale consideration, a residual balance remains which I am presently unable to clear under the original terms. I therefore request that the remaining dues be considered for a reasonable one-time settlement or restructured plan aligned with my present repayment capacity.' },
            { id: 'health_impact', label: 'Health-related impact on earning capacity', text: 'My ability to practice medicine and manage the clinic has been significantly affected by health issues, resulting in reduced working hours and lower professional income. These medical circumstances were not anticipated at the time the loans were taken and have directly affected my capacity to meet instalments on the original schedule. I continue to work within my medical limitations and to prioritise debt repayment from whatever income is available. In view of this genuine and continuing hardship, I am requesting a pragmatic restructuring or one-time settlement that reflects my current earning capacity.' },
            { id: 'income_collapse', label: 'Collapse in clinical income and operating environment', text: 'Over the past few years there has been a substantial and sustained decline in patient footfall and clinic revenues due to adverse market and regulatory conditions beyond my control. Fixed costs for staff, rent, and compliance have remained high, while receipts from practice have fallen sharply, creating persistent operating losses. I have responded by reducing expenses wherever possible and discontinuing unviable activities, but the income is still insufficient to service the loans on their original terms. I am therefore seeking a realistic restructuring or settlement so that repayments can continue without further defaults.' },
            { id: 'good_faith_borrower', label: 'Good-faith borrower requesting OTS/restructure', text: 'Since incurring these loans I have consistently acted in good faith by making payments whenever funds were available, selling assets, and cutting personal and business expenses to reduce my liabilities. Despite these efforts, my present income is not adequate to clear the full outstanding amount under the current schedule without jeopardising essential medical practice and family needs. I wish to resolve these accounts respectfully and avoid prolonged litigation by agreeing to a fair, sustainable settlement structure. I therefore request that the lender kindly consider a one-time settlement or restructured repayment plan in line with my documented financial position.' }
        ];
        var EVIDENCE_ITEMS = {
            cat1: [
                { id: 'clinic_reg', label: 'Clinic registration certificate (DMHO/health dept)' },
                { id: 'pharmacy_lic', label: 'Pharmacy drug licence' },
                { id: 'shop_lic', label: 'Shop & Establishment / Trade licence' },
                { id: 'pan', label: 'Entity PAN card' },
                { id: 'gst_reg', label: 'GST registration certificate' }
            ],
            cat2: [
                { id: 'rent_lease', label: 'Rent/lease agreement' },
                { id: 'equipment', label: 'Equipment purchase bills (furniture, medical devices)' },
                { id: 'signage', label: 'Signage/boards/LED installation bills' },
                { id: 'software', label: 'Hospital software licence/invoice' },
                { id: 'interior', label: 'Interior/renovation bills' },
                { id: 'interior_quote', label: 'Interior quotation / bill (HOMA Clinic)', accept: '.pdf,.jpg,.jpeg,.png,.csv', help: 'Example: HOMA Clinic turnkey interior quote around Rs. 17,20,349 (ceilings, partitions, pharmacy/lab/reception furniture, bathroom, electrical, doors, painting). Photos of completed interior can be added later for court/legal pack (not required for OTS emails).' }
            ],
            cat3: [
                { id: 'pollution', label: 'Pollution clearance / fire safety NOC (if applicable)' },
                { id: 'it_returns', label: 'IT returns (last 3 years)' },
                { id: 'gst_receipts', label: 'GST payment receipts' },
                { id: 'prof_tax', label: 'Professional tax receipts' },
                { id: 'govtFeesReceipts', label: 'Govt fees receipts (DMHO, registration, etc.)' }
            ],
            cat3b: [
                { id: 'utilityBills', label: 'Electricity/phone/internet bills' },
                { id: 'equipmentAdvances', label: 'Equipment advances (fans, AC, chairs, fridge, beds)' },
                { id: 'pharmaMarketingReceipts', label: 'Pharma/marketing dues and receipts' },
                { id: 'cashOnlineReceipts', label: 'Cash bills/online receipts' }
            ],
            cat4: [
                { id: 'digital_mkt', label: 'Digital marketing bills (Google Ads, social media)' },
                { id: 'print_ads', label: 'Print ads / pamphlets' },
                { id: 'website', label: 'Website development invoice' }
            ],
            cat5: [
                { id: 'dmho_closure', label: 'DMHO clinic closure request letter (signed)' },
                { id: 'drug_cancel', label: 'Drug licence cancellation request (signed)' },
                { id: 'landlord_noc', label: 'Landlord closure certificate / NOC' },
                { id: 'premises_handover', label: 'Premises handover letter' },
                { id: 'sale_deed', label: 'Registered sale deed of house / major asset sold to repay debts' },
                { id: 'bank_statement_proofs', label: 'Bank statement / payment proofs showing loan repayments from sale proceeds' }
            ],
            cat6: [
                { id: 'staff_salary', label: 'Staff salary dues certificate' },
                { id: 'pharma_bills', label: 'Pharmacy/distributor overdue bills' },
                { id: 'lab_vendor', label: 'Lab/vendor dues notices' },
                { id: 'borrower_health', label: 'Borrower health certificates' },
                { id: 'spouse_health', label: 'Spouse health certificates' },
                { id: 'medical_bills', label: 'Medical bills (high expenses)' },
                { id: 'court_summons', label: 'Court summons / legal notices' }
            ],
            cat8: [
                { id: 'prev_hospital_reg', label: 'Previous hospital / clinic registration certificate (e.g., Surendra Nehru Hospital, Godavarikhani)', help: 'Use this for old practice registration closed for starting this clinic.' }
            ],
            cat9: [
                { id: 'govt_service_order', label: 'Past government appointment order (Civil Assistant Surgeon, AP Government)' },
                { id: 'teaching_hospital_cert', label: 'Teaching hospital certificate (Osmania General Hospital / Medical College)' },
                { id: 'other_govt_service_proof', label: 'Other service/relieving certificates proving no current govt job or pension' }
            ]
        };

        function getVal(id) {
            var el = document.getElementById(id);
            return el ? String(el.value || '').trim() : '';
        }
        function getNum(id) { return parseFloat(getVal(id)) || 0; }
        function getChecked(id) {
            var el = document.getElementById(id);
            return el && el.checked;
        }
        function getFileName(inputId) {
            var el = document.getElementById(inputId);
            if (!el || !el.files || el.files.length === 0) return '';
            if (el.files.length === 1) return el.files[0].name || '';
            return Array.prototype.map.call(el.files, function(f) { return f.name; }).join(', ');
        }

        function renderEvidenceCategory(catId, containerId) {
            var items = EVIDENCE_ITEMS[catId] || [];
            var container = document.getElementById(containerId);
            if (!container) return;
            var html = '';
            items.forEach(function(it) {
                var fid = 'ev_' + it.id;
                var acceptVal = it.accept || '.pdf,.jpg,.jpeg,.png';
                html += '<div class="ev-item">' +
                    '<div class="cb-row"><input type="checkbox" id="chk_' + fid + '"><label for="chk_' + fid + '" style="display:inline;">' + it.label + '</label></div>' +
                    '<div class="file-row">File: <input type="file" id="file_' + fid + '" accept="' + acceptVal + '" style="font-size:11px;max-width:200px;"> <span id="fn_' + fid + '" style="color:#666;"></span></div>' +
                    (it.help ? '<div class="note-small">' + it.help + '</div>' : '') +
                    '</div>';
            });
            container.innerHTML = html;
            items.forEach(function(it) {
                var fid = 'ev_' + it.id;
                var fileEl = document.getElementById('file_' + fid);
                var fnEl = document.getElementById('fn_' + fid);
                if (fileEl && fnEl) {
                    fileEl.addEventListener('change', function() {
                        fnEl.textContent = fileEl.files && fileEl.files.length ? (fileEl.files.length === 1 ? fileEl.files[0].name : fileEl.files.length + ' files') : '';
                    });
                }
            });
        }

        function renderHardshipTemplates() {
            var listEl = document.getElementById('hardshipTemplatesList');
            var displayEl = document.getElementById('hardshipTemplateDisplay');
            if (!listEl || !displayEl) return;
            var html = '';
            HARDSHIP_TEMPLATES.forEach(function(t) {
                html += '<button type="button" class="hardship-template-label" data-template-id="' + t.id + '">' + t.label + '</button>';
            });
            listEl.innerHTML = html;
            listEl.querySelectorAll('.hardship-template-label').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var id = btn.getAttribute('data-template-id');
                    var t = HARDSHIP_TEMPLATES.filter(function(x) { return x.id === id; })[0];
                    if (t) displayEl.value = t.text;
                });
            });
            if (HARDSHIP_TEMPLATES.length > 0) displayEl.value = HARDSHIP_TEMPLATES[0].text;
        }

        function recalcInvestment() {
            var ids = ['inv_registration','inv_rent','inv_equipment','inv_signage','inv_software','inv_medicine'];
            var sum = ids.reduce(function(a, id) { return a + getNum(id); }, 0);
            var el = document.getElementById('inv_total');
            if (el) el.value = Math.round(sum);
        }
        function recalcLoan() {
            var emi = getNum('loan_emi');
            var months = getNum('loan_monthsPaid');
            var os = getNum('loan_outstanding');
            var pct = getNum('loan_otsPct') || 70;
            var totalPaid = Math.round(emi * months);
            var otsAmt = Math.round(os * (pct / 100));
            var savings = os - otsAmt;
            var pa = document.getElementById('loan_totalPaid'); if (pa) pa.value = totalPaid;
            var oa = document.getElementById('loan_otsAmt'); if (oa) oa.value = otsAmt;
            var sv = document.getElementById('loan_savings'); if (sv) sv.value = Math.round(savings);
        }
        function recalcMonths() {
            var rows = document.querySelectorAll('#monthTableBody tr');
            var totRev = 0, totExp = 0;
            rows.forEach(function(tr) {
                var rev = parseFloat(tr.querySelector('input.rev') && tr.querySelector('input.rev').value) || 0;
                var exp = parseFloat(tr.querySelector('input.exp') && tr.querySelector('input.exp').value) || 0;
                totRev += rev; totExp += exp;
                var net = rev - exp;
                var netEl = tr.querySelector('.net');
                if (netEl) netEl.textContent = net.toLocaleString();
            });
            var totNet = totRev - totExp;
            var r = document.getElementById('totRevenue'); if (r) r.textContent = totRev.toLocaleString();
            var e = document.getElementById('totExpenses'); if (e) e.textContent = totExp.toLocaleString();
            var n = document.getElementById('totNet'); if (n) n.textContent = totNet.toLocaleString();
        }

        function addMonthRow() {
            var tbody = document.getElementById('monthTableBody');
            if (!tbody) return;
            var m = tbody.querySelectorAll('tr').length + 1;
            var tr = document.createElement('tr');
            tr.innerHTML = '<td><input type="text" placeholder="e.g. Jan-2024" class="month" size="10"></td>' +
                '<td><input type="number" class="rev" min="0" placeholder="0" size="8"></td>' +
                '<td><input type="number" class="exp" min="0" placeholder="0" size="8"></td>' +
                '<td class="net">0</td>' +
                '<td><button type="button" class="btn" style="padding:2px 6px;font-size:11px;" data-remove>Remove</button></td>';
            tbody.appendChild(tr);
            tr.querySelectorAll('input.rev, input.exp').forEach(function(inp) {
                inp.addEventListener('input', recalcMonths);
            });
            tr.querySelector('[data-remove]').addEventListener('click', function() {
                tr.remove();
                recalcMonths();
            });
            recalcMonths();
        }

        function addAssetDebtRow(rowData) {
            var tbody = document.getElementById('assetDebtsTableBody');
            if (!tbody) return;
            var tr = document.createElement('tr');
            tr.className = 'asset-debt-row';
            var opts = '<option value="">--</option><option value="CLOSED">CLOSED</option><option value="PART-PAID">PART-PAID</option><option value="OTS PENDING">OTS PENDING</option>';
            tr.innerHTML = '<td><input type="text" class="asset-lender" placeholder="e.g. Bajaj Finance" style="width:100%;"></td>' +
                '<td><input type="text" class="asset-loanAccount" placeholder="Account / loan ref" style="width:100%;"></td>' +
                '<td><input type="number" class="asset-amount" min="0" placeholder="0" style="width:100%;"></td>' +
                '<td><select class="asset-status" style="width:100%;">' + opts + '</select></td>' +
                '<td><button type="button" class="btn" style="padding:2px 6px;font-size:11px;" data-remove>Remove</button></td>';
            tbody.appendChild(tr);
            if (rowData) {
                var lender = tr.querySelector('.asset-lender'); if (lender) lender.value = rowData.lender || '';
                var acct = tr.querySelector('.asset-loanAccount'); if (acct) acct.value = rowData.loanAccount || '';
                var amt = tr.querySelector('.asset-amount'); if (amt) amt.value = rowData.amountFromSale || '';
                var st = tr.querySelector('.asset-status'); if (st) st.value = rowData.closureStatus || '';
            }
            tr.querySelectorAll('.asset-amount').forEach(function(inp) {
                inp.addEventListener('input', recalcAssetDebtsTotal);
            });
            tr.querySelector('[data-remove]').addEventListener('click', function() {
                tr.remove();
                recalcAssetDebtsTotal();
            });
            recalcAssetDebtsTotal();
        }

        function recalcAssetDebtsTotal() {
            var sum = 0;
            document.querySelectorAll('#assetDebtsTableBody tr.asset-debt-row').forEach(function(tr) {
                var inp = tr.querySelector('input.asset-amount');
                sum += parseFloat(inp && inp.value) || 0;
            });
            var el = document.getElementById('asset_totalAppliedToDebt');
            if (el) el.value = Math.round(sum);
        }

        function collectStep5Data() {
            var invIds = ['inv_registration','inv_rent','inv_equipment','inv_signage','inv_software','inv_medicine'];
            var investment = {};
            invIds.forEach(function(id) {
                var key = id.replace('inv_','');
                investment[key] = getNum(id);
            });
            investment.total = getNum('inv_total');
            investment.interiorNote = getVal('inv_interiorNote');
            investment.govtFeesTotal = getNum('govtFeesTotal');
            investment.runningExpenses = {
                electricity: getNum('running_electricity'),
                advances: getNum('running_advances'),
                equipment: getNum('running_equipment')
            };
            investment.expensesNote = getVal('expensesNote');

            var monthlyData = [];
            document.querySelectorAll('#monthTableBody tr').forEach(function(tr) {
                var month = (tr.querySelector('input.month') && tr.querySelector('input.month').value) || '';
                var rev = parseFloat(tr.querySelector('input.rev') && tr.querySelector('input.rev').value) || 0;
                var exp = parseFloat(tr.querySelector('input.exp') && tr.querySelector('input.exp').value) || 0;
                if (month || rev || exp) monthlyData.push({ month: month, revenue: rev, expenses: exp, netProfitLoss: rev - exp });
            });

            var loanHistory = {
                lenderName: getVal('loan_lender'),
                accountNumber: getVal('loan_account'),
                loanAmountOriginal: getNum('loan_original'),
                processingFeesPaid: getNum('loan_processing'),
                firstEmiDate: getVal('loan_firstEmi'),
                emiAmount: getNum('loan_emi'),
                monthsPaid: getNum('loan_monthsPaid'),
                totalAmountPaid: getNum('loan_totalPaid'),
                outstandingBalance: getNum('loan_outstanding'),
                proposedOtsPct: getNum('loan_otsPct') || 70,
                otsAmount: getNum('loan_otsAmt'),
                savings: getNum('loan_savings')
            };

            var taxCompliance = {
                itReturnsFiled: { fy22: getChecked('tax_fy22'), fy23: getChecked('tax_fy23'), fy24: getChecked('tax_fy24') },
                itReturnsFiles: [getFileName('tax_file22'), getFileName('tax_file23'), getFileName('tax_file24')],
                gstPaid: getNum('tax_gst'),
                professionalTax: getNum('tax_prof'),
                otherGovtFees: getNum('tax_other')
            };

            var legalCosts = {
                courtNoticeFees: getNum('legal_notice'),
                lawyerFees: getNum('legal_lawyer'),
                courtFiles: getFileName('legal_files')
            };

            var healthExpenses = {
                borrowerMedical: getNum('health_borrower'),
                spouseMedical: getNum('health_spouse'),
                healthFiles: getFileName('health_files')
            };

            var evidenceChecklist = {};
            ['cat1','cat2','cat3','cat3b','cat4','cat5','cat6','cat8','cat9'].forEach(function(cat) {
                (EVIDENCE_ITEMS[cat] || []).forEach(function(it) {
                    var fid = 'ev_' + it.id;
                    var chk = getChecked('chk_' + fid);
                    var fn = getFileName('file_' + fid);
                    evidenceChecklist[it.id] = { checked: chk, fileName: fn || '' };
                });
            });

            var debtsRepaid = [];
            document.querySelectorAll('#assetDebtsTableBody tr.asset-debt-row').forEach(function(tr) {
                var lender = (tr.querySelector('.asset-lender') && tr.querySelector('.asset-lender').value) || '';
                var loanAccount = (tr.querySelector('.asset-loanAccount') && tr.querySelector('.asset-loanAccount').value) || '';
                var amountFromSale = parseFloat(tr.querySelector('.asset-amount') && tr.querySelector('.asset-amount').value) || 0;
                var closureStatus = (tr.querySelector('.asset-status') && tr.querySelector('.asset-status').value) || '';
                if (lender || loanAccount || amountFromSale || closureStatus) {
                    debtsRepaid.push({ lender: lender, loanAccount: loanAccount, amountFromSale: amountFromSale, closureStatus: closureStatus });
                }
            });

            var majorAssetSale = {
                propertyDescription: getVal('asset_propertyDesc'),
                propertyAddress: getVal('asset_address'),
                registrationDetails: getVal('asset_registrationDetails'),
                saleValue: getNum('asset_saleValue'),
                saleDate: getVal('asset_saleDate'),
                netAmountReceived: getNum('asset_netReceived'),
                reasonForSale: getVal('asset_reasonForSale'),
                usageNote: getVal('asset_usageNote'),
                debtsRepaid: debtsRepaid,
                totalAppliedToDebt: getNum('asset_totalAppliedToDebt'),
                remarks: getVal('asset_remarks')
            };

            return {
                exportedAt: new Date().toISOString(),
                lenderName: loanHistory.lenderName,
                accountNumber: loanHistory.accountNumber,
                previousPracticeNote: getVal('previousPracticeNote'),
                hardshipNoPensionNote: getVal('hardshipNoPensionNote'),
                investment: investment,
                monthlyData: monthlyData,
                loanHistory: loanHistory,
                taxCompliance: taxCompliance,
                legalCosts: legalCosts,
                healthExpenses: healthExpenses,
                majorAssetSale: majorAssetSale,
                evidenceChecklist: evidenceChecklist,
                hardshipFromStep4: window._step4ImportedData || null,
                emailTemplate: window._step4EmailBody || ''
            };
        }

        function importFromStep4() {
            var data = null;
            try {
                var raw = localStorage.getItem('debtEmpireStep4CaseData');
                if (raw) data = JSON.parse(raw);
            } catch (e) {}
            if (!data) {
                document.getElementById('importStatus').textContent = 'No Step 4 data in localStorage. Use Load Step 4 JSON File.';
                return;
            }
            window._step4ImportedData = data;
            window._step4EmailBody = data.emailBody || data.emailDraft || '';
            if (data.loanSnapshot) {
                var snap = data.loanSnapshot;
                var le = document.getElementById('loan_lender'); if (le) le.value = snap.provider || '';
                var ac = document.getElementById('loan_account'); if (ac) ac.value = snap.account || '';
                var os = document.getElementById('loan_outstanding'); if (os) os.value = snap.outstanding || '';
                var pc = document.getElementById('loan_otsPct'); if (pc) pc.value = snap.otsPercent || 70;
                recalcLoan();
            }
            document.getElementById('importStatus').textContent = 'Imported from Step 4. Hardship data merged for export.';
        }

        function loadStep4JsonFile(file) {
            var r = new FileReader();
            r.onload = function() {
                try {
                    var data = JSON.parse(r.result);
                    window._step4ImportedData = data;
                    window._step4EmailBody = data.emailBody || data.emailDraft || '';
                    if (data.loanSnapshot) {
                        var snap = data.loanSnapshot;
                        var le = document.getElementById('loan_lender'); if (le) le.value = snap.provider || '';
                        var ac = document.getElementById('loan_account'); if (ac) ac.value = snap.account || '';
                        var os = document.getElementById('loan_outstanding'); if (os) os.value = snap.outstanding || '';
                        var pc = document.getElementById('loan_otsPct'); if (pc) pc.value = snap.otsPercent || 70;
                        recalcLoan();
                    }
                    document.getElementById('importStatus').textContent = 'Loaded Step 4 JSON.';
                } catch (e) {
                    document.getElementById('importStatus').textContent = 'Error: Invalid JSON.';
                }
            };
            r.readAsText(file);
        }

        function saveTemplate() {
            var data = collectStep5Data();
            data._isTemplate = true;
            var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'step5-template-' + new Date().toISOString().slice(0,10) + '.json';
            document.body.appendChild(a);
            a.click();
            setTimeout(function() { document.body.removeChild(a); URL.revokeObjectURL(a.href); }, 100);
        }

        function loadTemplate(file) {
            var r = new FileReader();
            r.onload = function() {
                try {
                    var data = JSON.parse(r.result);
                    if (data.loanHistory) {
                        var l = data.loanHistory;
                        var set = function(id, v) { var e = document.getElementById(id); if (e) e.value = v; };
                        set('loan_lender', l.lenderName);
                        set('loan_account', l.accountNumber);
                        set('loan_original', l.loanAmountOriginal);
                        set('loan_processing', l.processingFeesPaid);
                        set('loan_firstEmi', l.firstEmiDate);
                        set('loan_emi', l.emiAmount);
                        set('loan_monthsPaid', l.monthsPaid);
                        set('loan_outstanding', l.outstandingBalance);
                        set('loan_otsPct', l.proposedOtsPct || 70);
                    }
                    if (data.previousPracticeNote != null) {
                        var e = document.getElementById('previousPracticeNote');
                        if (e) e.value = data.previousPracticeNote || '';
                    }
                    if (data.hardshipNoPensionNote != null) {
                        var e = document.getElementById('hardshipNoPensionNote');
                        if (e) e.value = data.hardshipNoPensionNote || '';
                    }
                    if (data.investment) {
                        var inv = data.investment;
                        ['registration','rent','equipment','signage','software','medicine'].forEach(function(k) {
                            var e = document.getElementById('inv_' + k);
                            if (e && inv[k] != null) e.value = inv[k];
                        });
                        if (inv.interiorNote != null) {
                            var e = document.getElementById('inv_interiorNote');
                            if (e) e.value = inv.interiorNote || '';
                        }
                        if (inv.govtFeesTotal != null) {
                            var e = document.getElementById('govtFeesTotal');
                            if (e) e.value = inv.govtFeesTotal;
                        }
                        if (inv.runningExpenses) {
                            var re = inv.runningExpenses;
                            var reEl = document.getElementById('running_electricity'); if (reEl && re.electricity != null) reEl.value = re.electricity;
                            var raEl = document.getElementById('running_advances'); if (raEl && re.advances != null) raEl.value = re.advances;
                            var rqEl = document.getElementById('running_equipment'); if (rqEl && re.equipment != null) rqEl.value = re.equipment;
                        }
                        if (inv.expensesNote != null) {
                            var e = document.getElementById('expensesNote');
                            if (e) e.value = inv.expensesNote || '';
                        }
                    }
                    if (data.majorAssetSale) {
                        var mas = data.majorAssetSale;
                        var set = function(id, v) { var e = document.getElementById(id); if (e && v != null && v !== '') e.value = v; };
                        set('asset_propertyDesc', mas.propertyDescription);
                        set('asset_address', mas.propertyAddress);
                        set('asset_registrationDetails', mas.registrationDetails);
                        set('asset_saleValue', mas.saleValue);
                        set('asset_saleDate', mas.saleDate);
                        set('asset_netReceived', mas.netAmountReceived);
                        set('asset_reasonForSale', mas.reasonForSale);
                        set('asset_usageNote', mas.usageNote);
                        set('asset_remarks', mas.remarks);
                        var tbody = document.getElementById('assetDebtsTableBody');
                        if (tbody && mas.debtsRepaid && mas.debtsRepaid.length) {
                            tbody.innerHTML = '';
                            mas.debtsRepaid.forEach(function(r) {
                                addAssetDebtRow({ lender: r.lender, loanAccount: r.loanAccount, amountFromSale: r.amountFromSale, closureStatus: r.closureStatus });
                            });
                        }
                        recalcAssetDebtsTotal();
                    }
                    recalcInvestment();
                    recalcLoan();
                    document.getElementById('importStatus').textContent = 'Template loaded. Update lender/account for new lender.';
                } catch (e) {
                    document.getElementById('importStatus').textContent = 'Error loading template.';
                }
            };
            r.readAsText(file);
        }

        function exportAsJSON() {
            var data = collectStep5Data();
            var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'evidence-package-' + (data.lenderName || 'lender').replace(/\s+/g,'_') + '-' + new Date().toISOString().slice(0,10) + '.json';
            document.body.appendChild(a);
            a.click();
            setTimeout(function() { document.body.removeChild(a); URL.revokeObjectURL(a.href); }, 100);
        }

        function exportAsCSV() {
            var data = collectStep5Data();
            var lines = [];
            lines.push('Section,Field,Value');
            lines.push('Lender,' + (data.lenderName || '').replace(/,/g,';') + ',' + (data.accountNumber || '').replace(/,/g,';'));
            if (data.previousPracticeNote) lines.push('Previous Practice Note,Note,' + (data.previousPracticeNote || '').replace(/,/g,';').replace(/\n/g,' '));
            if (data.hardshipNoPensionNote) lines.push('Hardship No Pension,Note,' + (data.hardshipNoPensionNote || '').replace(/,/g,';').replace(/\n/g,' '));
            lines.push('Investment,Total,' + (data.investment && data.investment.total));
            if (data.investment && data.investment.interiorNote) lines.push('Investment,Interior note,' + (data.investment.interiorNote || '').replace(/,/g,';').replace(/\n/g,' '));
            if (data.investment && data.investment.govtFeesTotal != null) lines.push('Expenses,Govt Fees,' + data.investment.govtFeesTotal);
            if (data.investment && data.investment.runningExpenses) {
                var re = data.investment.runningExpenses;
                if (re.electricity != null) lines.push('Expenses,Utilities,' + re.electricity);
                if (re.equipment != null) lines.push('Expenses,Equipment Advances,' + re.equipment);
                if (re.advances != null) lines.push('Expenses,Pharma/Marketing,' + re.advances);
            }
            if (data.investment && data.investment.expensesNote) lines.push('Expenses,Cash Receipts note,' + (data.investment.expensesNote || '').replace(/,/g,';').replace(/\n/g,' '));
            if (data.monthlyData) data.monthlyData.forEach(function(m) {
                lines.push('Monthly,' + (m.month||'').replace(/,/g,';') + ',' + m.revenue + ',' + m.expenses + ',' + (m.netProfitLoss||0));
            });
            if (data.loanHistory) {
                var l = data.loanHistory;
                lines.push('Loan,Outstanding,' + l.outstandingBalance);
                lines.push('Loan,OTS Amount,' + l.otsAmount);
            }
            if (data.majorAssetSale) {
                var mas = data.majorAssetSale;
                lines.push('Major Asset Sale,Property description,' + (mas.propertyDescription || '').replace(/,/g,';'));
                lines.push('Major Asset Sale,Location,' + (mas.propertyAddress || '').replace(/,/g,';'));
                lines.push('Major Asset Sale,Registration details,' + (mas.registrationDetails || '').replace(/,/g,';'));
                lines.push('Major Asset Sale,Sale value (Rs),' + (mas.saleValue || ''));
                lines.push('Major Asset Sale,Sale date,' + (mas.saleDate || ''));
                lines.push('Major Asset Sale,Total applied to debt (Rs),' + (mas.totalAppliedToDebt || ''));
                if (mas.debtsRepaid && mas.debtsRepaid.length) {
                    mas.debtsRepaid.forEach(function(r) {
                        lines.push('Major Asset Sale Debt,' + (r.lender||'').replace(/,/g,';') + ',' + (r.loanAccount||'').replace(/,/g,';') + ',' + (r.amountFromSale||'') + ',' + (r.closureStatus||'').replace(/,/g,';'));
                    });
                }
            }
            if (data.evidenceChecklist) {
                Object.keys(data.evidenceChecklist).forEach(function(k) {
                    var v = data.evidenceChecklist[k];
                    lines.push('Evidence,' + k + ',' + (v.checked?'Yes':'No') + ';' + (v.fileName||'').replace(/,/g,';'));
                });
            }
            var blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'evidence-package-' + new Date().toISOString().slice(0,10) + '.csv';
            document.body.appendChild(a);
            a.click();
            setTimeout(function() { document.body.removeChild(a); URL.revokeObjectURL(a.href); }, 100);
        }

        function buildPdfHtml(data) {
            var html = '<div style="font-family:Segoe UI,sans-serif;font-size:12px;line-height:1.5;">';
            html += '<h1 style="text-align:center;margin-bottom:20px;">Comprehensive Hardship & Financial Evidence – ' + (data.lenderName || 'Lender') + '</h1>';
            html += '<h2>Executive Summary</h2>';
            var lh = data.loanHistory || {};
html += '<p>Account: ' + (data.accountNumber || '—') + ' | Outstanding: Rs ' + (lh.outstandingBalance || 0).toLocaleString() + ' | OTS Amount: Rs ' + (lh.otsAmount || 0).toLocaleString() + ' | Savings: Rs ' + (lh.savings || 0).toLocaleString() + '</p>';
            html += '<h2>Investment & Setup</h2><p>Total Investment: Rs ' + (data.investment && data.investment.total || 0).toLocaleString();
            if (data.investment && data.investment.interiorNote) html += ' (Interior: ' + (data.investment.interiorNote || '').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,' ') + ')';
            html += '</p>';
            if (data.investment) {
                var inv = data.investment;
                if (inv.govtFeesTotal != null && inv.govtFeesTotal > 0) html += '<p>Govt Fees: Rs ' + (inv.govtFeesTotal || 0).toLocaleString() + '</p>';
                if (inv.runningExpenses) {
                    var re = inv.runningExpenses;
                    var runSum = (re.electricity || 0) + (re.advances || 0) + (re.equipment || 0);
                    if (runSum > 0) html += '<p>Running Expenses: Rs ' + runSum.toLocaleString() + ' (Electricity/Phone/Internet: ' + (re.electricity || 0).toLocaleString() + ', Advances: ' + (re.advances || 0).toLocaleString() + ', Equipment: ' + (re.equipment || 0).toLocaleString() + ')</p>';
                }
                if (inv.expensesNote) html += '<p><strong>Expenses note:</strong> ' + (inv.expensesNote || '').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>') + '</p>';
            }
            html += '<h2>Monthly Revenue & Losses</h2>';
            html += '<table border="1" cellpadding="4" style="border-collapse:collapse;width:100%;"><tr><th>Month</th><th>Revenue</th><th>Expenses</th><th>Net P/L</th></tr>';
            (data.monthlyData || []).forEach(function(m) {
                html += '<tr><td>' + (m.month||'') + '</td><td>' + m.revenue + '</td><td>' + m.expenses + '</td><td>' + (m.netProfitLoss||0) + '</td></tr>';
            });
            html += '</table>';
            html += '<h2>Evidence Checklist</h2><ul>';
            if (data.evidenceChecklist) {
                Object.keys(data.evidenceChecklist).forEach(function(k) {
                    var v = data.evidenceChecklist[k];
                    var label = (k === 'interior_quote') ? 'Interior quotation/bill' : k;
                    if (v.checked) html += '<li>' + label + ' – Attached: ' + (v.fileName || '(file)') + '</li>';
                });
            }
            html += '</ul>';
            if (data.previousPracticeNote) {
                html += '<h3>Note about earlier hospital closed for this clinic</h3><p>' + (data.previousPracticeNote || '').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>') + '</p>';
            }
            if (data.hardshipNoPensionNote) {
                html += '<h3>Hardship – No Govt Job or Pension</h3><p>' + (data.hardshipNoPensionNote || '').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>') + '</p>';
            }
            if (data.majorAssetSale && (data.majorAssetSale.propertyDescription || data.majorAssetSale.saleValue || (data.majorAssetSale.debtsRepaid && data.majorAssetSale.debtsRepaid.length))) {
                var mas = data.majorAssetSale;
                html += '<h2>Major Asset Sold to Repay Debts</h2>';
                html += '<p>' + (mas.propertyDescription || '').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '. ' + (mas.propertyAddress || '').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</p>';
                if (mas.registrationDetails) html += '<p>Registration: ' + (mas.registrationDetails || '').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</p>';
                html += '<p>Sale value: Rs ' + (mas.saleValue || 0).toLocaleString() + ' | Sale date: ' + (mas.saleDate || '—') + '</p>';
                if (mas.reasonForSale) html += '<p><strong>Reason for sale:</strong> ' + (mas.reasonForSale || '').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</p>';
                if (mas.usageNote) html += '<p><strong>Usage of proceeds:</strong> ' + (mas.usageNote || '').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</p>';
                if (mas.debtsRepaid && mas.debtsRepaid.length) {
                    html += '<table border="1" cellpadding="4" style="border-collapse:collapse;width:100%;margin-top:8px;"><tr><th>Lender</th><th>Account</th><th>Amount (Rs)</th><th>Status</th></tr>';
                    mas.debtsRepaid.forEach(function(r) {
                        html += '<tr><td>' + (r.lender||'').replace(/</g,'&lt;') + '</td><td>' + (r.loanAccount||'').replace(/</g,'&lt;') + '</td><td>' + (r.amountFromSale||0).toLocaleString() + '</td><td>' + (r.closureStatus||'').replace(/</g,'&lt;') + '</td></tr>';
                    });
                    html += '</table>';
                }
            }
            if (data.hardshipFromStep4 && data.emailTemplate) {
                html += '<h2>Hardship Narrative (from Step 4)</h2><pre style="white-space:pre-wrap;background:#f5f5f5;padding:12px;">' + (data.emailTemplate || '').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</pre>';
            }
            html += '</div>';
            return html;
        }

        function exportAsPDF() {
            if (typeof html2pdf === 'undefined') { alert('PDF library loading... Try again.'); return; }
            var data = collectStep5Data();
            var content = document.getElementById('pdfContent');
            content.innerHTML = buildPdfHtml(data);
            var opt = { margin: 10, filename: 'evidence-package-' + (data.lenderName||'lender').replace(/\s+/g,'_') + '-' + new Date().toISOString().slice(0,10) + '.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, letterRendering: true, logging: false }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            var doCapture = function() {
                html2pdf().set(opt).from(content).save().then(function() {
                    content.innerHTML = '';
                }).catch(function(err) {
                    content.innerHTML = '';
                    alert('PDF export failed. Try Save as JSON or CSV instead. ' + (err && err.message ? err.message : ''));
                });
            };
            requestAnimationFrame(function() {
                requestAnimationFrame(function() {
                    setTimeout(doCapture, 150);
                });
            });
        }

        function init() {
            ['inv_registration','inv_rent','inv_equipment','inv_signage','inv_software','inv_medicine'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el) el.addEventListener('input', recalcInvestment);
            });
            ['loan_emi','loan_monthsPaid','loan_outstanding','loan_otsPct'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el) el.addEventListener('input', recalcLoan);
            });
            renderEvidenceCategory('cat1', 'ev_cat1');
            renderEvidenceCategory('cat2', 'ev_cat2');
            renderEvidenceCategory('cat3', 'ev_cat3');
            renderEvidenceCategory('cat3b', 'ev_cat3b');
            renderEvidenceCategory('cat4', 'ev_cat4');
            renderEvidenceCategory('cat5', 'ev_cat5');
            renderEvidenceCategory('cat6', 'ev_cat6');
            renderEvidenceCategory('cat8', 'ev_cat8');
            renderEvidenceCategory('cat9', 'ev_cat9');
            renderHardshipTemplates();
            document.getElementById('btnCopyHardshipTemplate').addEventListener('click', function() {
                var ta = document.getElementById('hardshipTemplateDisplay');
                if (ta && navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(ta.value).then(function() { alert('Copied to clipboard.'); }).catch(function() {});
                }
            });
            document.getElementById('btnAddMonth').addEventListener('click', addMonthRow);
            addMonthRow();
            document.getElementById('btnAddAssetDebt').addEventListener('click', function() { addAssetDebtRow(); });
            addAssetDebtRow();
            document.getElementById('btnImportStep4').addEventListener('click', importFromStep4);
            document.getElementById('btnLoadStep4Json').addEventListener('click', function() { document.getElementById('loadStep4File').click(); });
            document.getElementById('loadStep4File').addEventListener('change', function() { var f = this.files[0]; if (f) loadStep4JsonFile(f); this.value = ''; });
            document.getElementById('btnSaveTemplate').addEventListener('click', saveTemplate);
            document.getElementById('btnLoadTemplate').addEventListener('click', function() { document.getElementById('loadTemplateFile').click(); });
            document.getElementById('loadTemplateFile').addEventListener('change', function() { var f = this.files[0]; if (f) loadTemplate(f); this.value = ''; });
            document.getElementById('btnGenerate').addEventListener('click', function() {
                try {
                    collectStep5Data();
                    var msg = 'Data collected. Use Save as JSON / CSV / PDF below.';
                    document.getElementById('importStatus').textContent = msg;
                    var gs = document.getElementById('generateStatus');
                    if (gs) { gs.textContent = msg; gs.style.color = '#2e7d32'; }
                } catch (e) {
                    var err = 'Error: ' + (e && e.message ? e.message : 'Could not collect data');
                    document.getElementById('importStatus').textContent = err;
                    var gs = document.getElementById('generateStatus');
                    if (gs) { gs.textContent = err; gs.style.color = '#c62828'; }
                }
            });
            document.getElementById('btnExportJSON').addEventListener('click', exportAsJSON);
            document.getElementById('btnExportCSV').addEventListener('click', exportAsCSV);
            document.getElementById('btnExportPDF').addEventListener('click', exportAsPDF);
            recalcInvestment();
            recalcLoan();
        }
        init();
    })();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</body>
</html>
